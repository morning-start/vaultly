# 数据字典

> **版本**: v1.1.0  
> **更新日期**: 2026-02-20  
> **作者**: Vaultly Team  
> **文档体系**: 渐进式文档（project-wiki）

---

## 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-02-20 | 初始版本 | Vaultly Team |
| v1.1.0 | 2026-02-20 | 添加 TOTP 数据模型、完善代码实现映射 | Vaultly Team |

---

## 一、核心数据模型

### 1.1 条目类型枚举

```dart
enum EntryType {
  login,       // 登录凭证
  bankCard,    // 银行卡
  secureNote,  // 安全笔记
  identity,    // 身份信息
  custom,      // 自定义
}

enum CardType {
  visa,
  mastercard,
  amex,
  discover,
  jcb,
  unionPay,
  other,
}

enum FieldType {
  text,
  hidden,
  date,
  url,
  email,
  phone,
  number,
}
```

### 1.2 VaultEntry - 基础条目

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | string (UUID) | 是 | 自动生成 | 唯一标识 |
| title | string | 是 | - | 条目标题 |
| type | EntryType | 是 | - | 条目类型 |
| createdAt | datetime | 是 | 创建时间 | 创建时间 |
| updatedAt | datetime | 是 | 更新时间 | 更新时间 |
| customFields | List\<CustomField\> | 否 | \[\] | 自定义字段 |
| tags | List\<string\> | 否 | \[\] | 标签 |
| isFavorite | bool | 否 | false | 是否收藏 |
| folderId | string? | 否 | null | 文件夹 ID |

### 1.3 LoginEntry - 登录凭证

| 字段名 | 类型 | 必填 | 加密 | 说明 |
|--------|------|------|------|------|
| username | string? | 否 | 否 | 用户名 |
| email | string? | 否 | 否 | 邮箱 |
| password | string | 是 | ✅ | 密码 |
| url | string? | 否 | 否 | 网站 URL |
| totpSecret | string? | 否 | ✅ | TOTP 密钥 |
| notes | string? | 否 | ✅ | 备注 |
| favIcons | List\<string\> | 否 | 否 | 网站图标 |

### 1.4 BankCardEntry - 银行卡

| 字段名 | 类型 | 必填 | 加密 | 说明 |
|--------|------|------|------|------|
| cardNumber | string | 是 | ✅ | 卡号 |
| cardHolderName | string | 是 | 否 | 持卡人姓名 |
| expiryMonth | int | 是 | 否 | 有效期月 |
| expiryYear | int | 是 | 否 | 有效期年 |
| cvv | string? | 否 | ✅ | CVV 码 |
| bankName | string? | 否 | 否 | 银行名称 |
| cardType | CardType | 否 | 否 | 卡类型 |

### 1.5 SecureNoteEntry - 安全笔记

| 字段名 | 类型 | 必填 | 加密 | 说明 |
|--------|------|------|------|------|
| content | string | 是 | ✅ | 笔记内容 |
| isMarkdown | bool | 否 | 否 | 是否支持 Markdown |

### 1.6 IdentityEntry - 身份信息

| 字段名 | 类型 | 必填 | 加密 | 说明 |
|--------|------|------|------|------|
| firstName | string? | 否 | 否 | 名 |
| lastName | string? | 否 | 否 | 姓 |
| middleName | string? | 否 | 否 | 中间名 |
| birthDate | date? | 否 | 否 | 出生日期 |
| idNumber | string? | 否 | ✅ | 证件号码 |
| address | string? | 否 | 否 | 地址 |
| phone | string? | 否 | 否 | 电话 |
| email | string? | 否 | 否 | 邮箱 |

### 1.7 CustomField - 自定义字段

| 字段名 | 类型 | 必填 | 加密 | 说明 |
|--------|------|------|------|------|
| name | string | 是 | 否 | 字段名称 |
| value | string | 是 | ✅ | 字段值 |
| type | FieldType | 否 | 否 | 字段类型 |
| isSecret | bool | 否 | false | 是否敏感 |

### 1.8 TOTPConfig - TOTP 配置

| 字段名 | 类型 | 必填 | 加密 | 说明 |
|--------|------|------|------|------|
| id | string (UUID) | 是 | 否 | 唯一标识 |
| secret | string | 是 | ✅ | Base32 编码密钥 |
| issuer | string | 是 | 否 | 服务商名称 |
| accountName | string | 是 | 否 | 账号名称 |
| digits | int | 否 | 否 | 验证码位数（默认 6）|
| period | int | 否 | 否 | 时间步长（默认 30）|
| algorithm | Algorithm | 否 | 否 | 哈希算法（默认 sha1）|
| entryId | string? | 否 | 否 | 关联的登录条目 ID |
| createdAt | datetime | 是 | 否 | 创建时间 |
| updatedAt | datetime | 是 | 否 | 更新时间 |

```dart
enum Algorithm {
  sha1,       // HMAC-SHA1（RFC 6238 标准）
  sha256,     // HMAC-SHA256
  sha512,     // HMAC-SHA512
}
```

### 1.9 TOTPState - TOTP 状态

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| currentCode | string | 是 | 当前验证码 |
| remainingSeconds | int | 是 | 剩余有效秒数 |
| isGenerating | bool | 是 | 是否正在生成 |
| error | TOTPError? | 否 | 错误信息 |
| lastUpdated | datetime | 是 | 最后更新时间 |

---

## 二、认证数据

### 2.1 AuthConfig - 认证配置

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| vaultId | string | 是 | 保险库 ID |
| passwordHash | string | 是 | 密码哈希 |
| salt | string | 是 | 盐值 |
| lockTimeout | int | 否 | 锁定超时(分钟) |
| failedAttempts | int | 否 | 失败次数 |
| lockedUntil | datetime? | 否 | 锁定截止时间 |

### 2.2 Session - 会话

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| sessionId | string | 是 | 会话 ID |
| createdAt | datetime | 是 | 创建时间 |
| lastActiveAt | datetime | 是 | 最后活跃时间 |
| isLocked | bool | 是 | 是否锁定 |

---

## 三、同步数据

### 3.1 VaultMetadata - 保险库元数据

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | string | 是 | 保险库 ID |
| version | int | 是 | 数据版本 |
| salt | string | 是 | 盐值 |
| argon2Hash | string | 是 | Argon2 哈希 |
| lastSyncedAt | datetime | 否 | 最后同步时间 |
| entryCount | int | 否 | 条目数量 |
| checksum | string | 否 | 数据校验和 |

### 3.2 WebDAVConfig - WebDAV 配置

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| serverUrl | string | 是 | 服务器 URL |
| username | string | 是 | 用户名 |
| password | string | 是 | 密码(加密) |
| remotePath | string | 是 | 远程路径 |
| enableSync | bool | 否 | 启用同步 |
| syncInterval | int | 否 | 同步间隔 |

### 3.3 SyncState - 同步状态

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| status | SyncStatus | 是 | 同步状态 |
| lastSyncTime | datetime? | 否 | 最后同步时间 |
| localHash | string? | 否 | 本地哈希 |
| remoteHash | string? | 否 | 远程哈希 |
| conflicts | List\<Conflict\> | 否 | 冲突列表 |
| errorMessage | string? | 否 | 错误信息 |

---

## 四、ER 图

### 4.1 实体关系图

```mermaid
erDiagram
    VaultEntry ||--o{ CustomField : contains
    VaultEntry ||--o{ Tag : has
    VaultEntry }o--|| Folder : belongs_to
    VaultEntry ||--o{ TOTPConfig : has_totp
    LoginEntry {
        string id PK
        string password FK
        string totpSecret FK
    }
    BankCardEntry {
        string id PK
        string cardNumber FK
        string cvv FK
    }
    SecureNoteEntry {
        string id PK
        string content FK
    }
    IdentityEntry {
        string id PK
        string idNumber FK
    }
    TOTPConfig {
        string id PK
        string secret FK
        string issuer
        string accountName
        string entryId FK
    }
    Folder {
        string id PK
        string name
        string parentId FK
    }
```

### 4.2 实体关系说明

| 关系 | 类型 | 说明 |
|------|------|------|
| VaultEntry → CustomField | 1:N | 一个条目包含多个自定义字段 |
| VaultEntry → Tag | 1:N | 一个条目可打多个标签 |
| VaultEntry → Folder | N:1 | 多个条目属于一个文件夹 |
| VaultEntry → TOTPConfig | 1:0..1 | 一个条目可关联一个 TOTP 配置 |
| Folder → Folder | 1:N | 文件夹支持嵌套（自引用）|

---

## 五、数据流

### 5.1 数据加密流

```
明文数据 (PlainText)
       │
       ▼
┌──────────────────┐
│  AES-256-GCM    │  ◄── 加密密钥 (来自 Argon2id)
│    加密          │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  密文 + IV + Tag │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│    Isar DB      │
└──────────────────┘
```

---

## 六、代码实现映射

### 6.1 数据模型实现

| 文档模型 | 实现文件 | 说明 |
|----------|----------|------|
| **VaultEntry** | `lib/core/models/vault_entry.dart` | 条目基类 |
| **LoginEntry** | `lib/core/models/vault_entry.dart` | 登录凭证条目 |
| **BankCardEntry** | `lib/core/models/vault_entry.dart` | 银行卡条目 |
| **SecureNoteEntry** | `lib/core/models/vault_entry.dart` | 安全笔记条目 |
| **IdentityEntry** | `lib/core/models/vault_entry.dart` | 身份信息条目 |
| **TOTPConfig** | `lib/core/services/totp_service.dart` | TOTP 配置模型 |
| **VaultMetadata** | `lib/core/models/vault_entry.dart` | 保险库元数据 |
| **SyncMetadata** | `lib/core/models/sync_metadata.dart` | 同步元数据 |

### 6.2 枚举实现

```dart
// lib/core/models/vault_entry.dart
enum EntryType {
  login,       // 登录凭证
  bankCard,    // 银行卡
  secureNote,  // 安全笔记
  identity,    // 身份信息
  custom,      // 自定义
}

enum CardType {
  visa,
  mastercard,
  amex,
  discover,
  jcb,
  unionPay,
  other,
}

enum Algorithm {
  sha1,       // HMAC-SHA1（RFC 6238 标准）
  sha256,     // HMAC-SHA256
  sha512,     // HMAC-SHA512
}
```

### 6.3 核心模型代码

```dart
// lib/core/models/vault_entry.dart
abstract class VaultEntry {
  final String id;
  final String title;
  final EntryType type;
  final DateTime createdAt;
  final DateTime updatedAt;
  final bool isArchived;
  final bool isFavorite;
  final List<String> tags;
  final String? folderId;
  final EncryptedData? encryptedData;

  VaultEntry({
    required this.id,
    required this.title,
    required this.type,
    required this.createdAt,
    required this.updatedAt,
    this.isArchived = false,
    this.isFavorite = false,
    this.tags = const [],
    this.folderId,
    this.encryptedData,
  });
}

class LoginEntry extends VaultEntry {
  final String? url;
  final String? username;
  final String? email;
  final List<String>? favIcons;

  LoginEntry({
    required super.id,
    required super.title,
    required super.createdAt,
    required super.updatedAt,
    this.url,
    this.username,
    this.email,
    this.favIcons,
    super.encryptedData,
  }) : super(type: EntryType.login);
}
```

---

## 七、相关文档

### 7.1 数据模型
- [加密结构](./加密结构.md) - 加密数据格式

### 7.2 架构设计
- [整体架构](../02-架构设计/整体架构.md) - 系统架构
- [安全架构](../02-架构设计/安全架构.md) - 安全设计

### 7.3 模块设计
- [保险库模块](../03-模块设计/保险库模块.md) - 条目管理设计
- [TOTP 模块](../03-模块设计/TOTP模块.md) - TOTP 功能设计

### 7.4 渐进式文档链
- [保险库管理功能](../功能文档/保险库管理功能.md) - 功能需求
- [保险库管理需求](../需求文档/保险库管理需求.md) - 数据模型与数据流
- [TOTP 双因素认证功能](../功能文档/TOTP双因素认证功能.md) - TOTP 功能需求
- [TOTP 双因素认证需求](../需求文档/TOTP双因素认证需求.md) - TOTP 数据模型
