# 加密结构

## 一、加密数据格式

### 1.1 EncryptedData 结构

所有敏感字段加密后存储为 `EncryptedData`：

```dart
class EncryptedData {
  String cipherText;     // Base64 编码的密文
  String iv;            // 初始化向量 (12 bytes, Base64)
  String authTag;       // 认证标签 (16 bytes, Base64)
  int version;          // 加密版本号
}
```

### 1.2 字段加密映射

| 字段 | 加密 | 说明 |
|------|------|------|
| LoginEntry.password | ✅ | 始终加密 |
| LoginEntry.totpSecret | ✅ | 始终加密 |
| LoginEntry.notes | ✅ | 可选加密 |
| BankCardEntry.cardNumber | ✅ | 始终加密 |
| BankCardEntry.cvv | ✅ | 始终加密 |
| SecureNoteEntry.content | ✅ | 始终加密 |
| IdentityEntry.idNumber | ✅ | 始终加密 |
| CustomField.value | ✅ | 如果 isSecret=true |
| 条目标题 | ❌ | 可搜索，不加密 |
| 条目类型 | ❌ | 索引需要 |

---

## 二、加密元数据

### 2.1 VaultMetadata 结构

```dart
class VaultMetadata {
  String id;              // 保险库唯一标识
  int version;           // 数据结构版本
  String salt;           // 主密码盐值 (Base64)
  String argon2Hash;    // Argon2id 哈希 (用于验证)
  DateTime? lastSyncedAt;
  int entryCount;
  String checksum;      // 数据完整性校验
}
```

### 2.2 存储位置

| 数据 | 存储位置 | 加密 |
|------|---------|------|
| VaultMetadata | Isar | ❌ |
| Salt | Isar | ❌ |
| Argon2Hash | Isar | ❌ |
| 加密密钥 | Secure Storage | ✅ (平台安全) |
| 加密字段 | Isar | ✅ |

---

## 三、加密流程

### 3.1 数据加密流程

```dart
class CryptoService {
  Future<EncryptedData> encrypt(String plainText, Uint8List key) async {
    // 1. 生成随机 IV (12 bytes for GCM)
    final iv = _generateSecureRandom(12);
    
    // 2. 创建 GCM 模式的 AES 加密器
    final encrypter = Encrypter(AES(
      Key(key),
      mode: AESMode.gcm,
    ));
    
    // 3. 加密
    final encrypted = encrypter.encrypt(plainText, iv: IV(iv));
    
    // 4. 提取认证标签 (GCM 最后 16 bytes)
    final authTag = encrypted.bytes.sublist(
      encrypted.bytes.length - 16,
      encrypted.bytes.length,
    );
    
    // 5. 返回加密数据
    return EncryptedData(
      cipherText: encrypted.base64,
      iv: base64Encode(iv),
      authTag: base64Encode(authTag),
      version: 1,
    );
  }
}
```

### 3.2 数据解密流程

```dart
class CryptoService {
  Future<String> decrypt(EncryptedData encrypted, Uint8List key) async {
    // 1. 解码 IV
    final iv = base64Decode(encrypted.iv);
    
    // 2. 创建解密器
    final encrypter = Encrypter(AES(
      Key(key),
      mode: AESMode.gcm,
    ));
    
    // 3. 解密
    final decrypted = encrypter.decrypt(
      Encrypted.fromBase64(encrypted.cipherText),
      iv: IV(iv),
    );
    
    return decrypted;
  }
}
```

---

## 四、密钥派生

### 4.1 Argon2id 参数

```dart
class Argon2Params {
  static const int memory = 65536;      // 64 MB
  static const int iterations = 3;
  static const int parallelism = 4;
  static const int saltLength = 32;     // 32 bytes
  static const int keyLength = 32;      // 256 bits
}
```

### 4.2 密钥派生流程

```dart
class KeyDerivationService {
  Future<KeyMaterial> deriveKey(String password, Uint8List salt) async {
    // 1. 配置 Argon2id 参数
    final params = Argon2Parameters(
      memory: 65536,
      iterations: 3,
      parallelism: 4,
      salt: salt,
      type: Argon2Parameters.ARGON2_ID,
    );
    
    // 2. 派生密钥
    final argon2 = Argon2Algorithm();
    final result = argon2.hashPasswordBytes(
      utf8.encode(password),
      params,
    );
    
    // 3. 返回密钥材料
    return KeyMaterial(
      key: Uint8List.fromList(result.hashBytes),
      salt: salt,
      hash: result.toString(),
    );
  }
}
```

---

## 五、存储结构

### 5.1 Isar 数据库结构

```
Isar Database
├── vault_entries
│   ├── id (indexed)
│   ├── title (indexed)
│   ├── type (indexed)
│   ├── encrypted_data
│   ├── tags (indexed)
│   ├── is_favorite
│   └── timestamps
├── vault_metadata
│   ├── vault_id
│   ├── salt
│   ├── password_hash
│   └── settings
└── sync_state
    ├── last_sync
    ├── local_hash
    └── remote_hash
```

### 5.2 加密字段存储示例

```dart
// LoginEntry 存储结构
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "title": "Google 账号",
  "type": "login",
  "username": "user@gmail.com",
  "password": {           // 加密字段
    "cipherText": "...",
    "iv": "...",
    "authTag": "...",
    "version": 1
  },
  "url": "https://google.com",
  "totpSecret": {        // 加密字段
    "cipherText": "...",
    "iv": "...",
    "authTag": "...",
    "version": 1
  },
  "tags": ["work", "google"],
  "isFavorite": true,
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z"
}
```

---

## 六、完整性校验

### 6.1 校验和计算

```dart
class ChecksumService {
  String calculateChecksum(List<VaultEntry> entries) {
    // 1. 序列化所有条目（排除时间戳）
    final json = _serializeForChecksum(entries);
    
    // 2. 计算 SHA-256
    final bytes = utf8.encode(json);
    final digest = sha256.convert(bytes);
    
    return digest.toString();
  }
  
  bool verifyChecksum(String expected, List<VaultEntry> entries) {
    final actual = calculateChecksum(entries);
    return actual == expected;
  }
}
```

---

## 七、相关文档

- [数据字典](./数据字典.md) - 数据结构定义
- [安全架构](../02-架构设计/安全架构.md) - 安全设计
- [整体架构](../02-架构设计/整体架构.md) - 系统架构
