# 架构师视图

> 为架构师提供的技术选型、整体架构、可扩展性设计指南

---

## 一、技术选型总览

### 1.1 核心技术栈

| 层级 | 技术选型 | 备选方案 | 选择理由 |
|------|---------|---------|---------|
| **框架** | Flutter 3.27+ | React Native | 跨平台能力强，性能优秀，UI一致性 |
| **状态管理** | Riverpod | flutter_bloc | 轻量、类型安全、编译时安全 |
| **本地数据库** | Isar | Hive, SQLite | 高性能、支持复杂查询、原生加密支持 |
| **加密** | AES-256-GCM | ChaCha20-Poly1305 | 业界标准，硬件加速支持好 |
| **密钥派生** | Argon2id | PBKDF2, scrypt | 密码哈希竞赛 winner，抗 GPU/ASIC |
| **同步协议** | WebDAV | 自定义协议 | 兼容主流 NAS，用户可控 |
| **插件框架** | WXT | 原生 Manifest V3 | 现代化，开发体验好 |

### 1.2 架构决策记录 (ADR)

#### ADR-001: 选择 Flutter 作为跨平台框架

**状态**: 已接受

**背景**: 需要支持 iOS、Android、Desktop、Web 多平台

**决策**: 使用 Flutter 3.27+

**理由**:
- 单一代码库覆盖所有目标平台
- 接近原生的性能
- 丰富的生态系统和插件
- 优秀的开发体验（Hot Reload）

**后果**:
- 需要 Dart 技能栈
- Web 平台有 SEO 限制（可接受）

#### ADR-002: 选择端到端加密架构

**状态**: 已接受

**背景**: 密码管理器必须保证数据安全

**决策**: 采用零知识架构，端到端加密

**理由**:
- 服务器无法解密用户数据
- 即使服务器被攻破，数据仍然安全
- 符合隐私保护最佳实践

**后果**:
- 无法提供密码找回功能
- 需要用户自行备份主密码

---

## 二、整体架构

### 2.1 系统架构图

```mermaid
graph TB
    subgraph "客户端层"
        Mobile[iOS/Android App]
        Desktop[Windows/macOS/Linux]
        Web[Web App]
        Extension[Browser Extension]
    end
    
    subgraph "核心业务层"
        Auth[认证服务]
        Vault[保险库服务]
        Sync[同步服务]
        TOTP[TOTP 服务]
    end
    
    subgraph "数据访问层"
        Isar[(Isar DB)]
        Keychain[系统密钥链]
        WebDAVClient[WebDAV 客户端]
    end
    
    subgraph "外部服务"
        WebDAV[WebDAV Server]
        NAS[用户 NAS]
    end
    
    Mobile --> Auth
    Desktop --> Auth
    Web --> Auth
    Extension -.-> Web
    
    Auth --> Vault
    Vault --> Sync
    Vault --> TOTP
    
    Auth --> Keychain
    Vault --> Isar
    Sync --> WebDAVClient
    
    WebDAVClient --> WebDAV
    WebDAV --> NAS
```

### 2.2 模块依赖关系

```mermaid
graph LR
    subgraph "模块依赖"
        Core[核心模块]
        Auth[认证模块]
        Vault[保险库模块]
        Sync[同步模块]
        UI[UI 模块]
    end
    
    Core --> Auth
    Core --> Vault
    Core --> Sync
    
    Auth --> Vault
    Vault --> Sync
    
    Auth --> UI
    Vault --> UI
    Sync --> UI
```

**依赖规则**:
- 核心模块（加密、工具）不依赖其他模块
- 认证模块是最底层业务模块
- UI 模块依赖所有业务模块
- 禁止循环依赖

---

## 三、可扩展性设计

### 3.1 水平扩展能力

| 扩展点 | 当前实现 | 未来扩展 |
|--------|---------|---------|
| 认证方式 | 主密码 + 生物识别 | + PIN 码、硬件密钥 |
| 同步协议 | WebDAV | + S3、Google Drive |
| 条目类型 | 4 种 | + 自定义类型 |
| 加密算法 | AES-256-GCM | + 算法可配置 |

### 3.2 插件化架构

```mermaid
graph TB
    subgraph "插件系统"
        Core[核心系统]
        PluginManager[插件管理器]
        
        subgraph "插件类型"
            AuthPlugin[认证插件]
            SyncPlugin[同步插件]
            ImportPlugin[导入插件]
        end
    end
    
    Core --> PluginManager
    PluginManager --> AuthPlugin
    PluginManager --> SyncPlugin
    PluginManager --> ImportPlugin
```

### 3.3 多租户支持（未来）

```mermaid
graph TB
    subgraph "多租户架构"
        Tenant1[租户 A]
        Tenant2[租户 B]
        
        subgraph "共享服务"
            Gateway[API 网关]
            AuthService[认证服务]
        end
        
        subgraph "隔离资源"
            DB1[(数据库 A)]
            DB2[(数据库 B)]
        end
    end
    
    Tenant1 --> Gateway
    Tenant2 --> Gateway
    Gateway --> AuthService
    AuthService --> DB1
    AuthService --> DB2
```

---

## 四、性能设计

### 4.1 性能目标

| 指标 | 目标值 | 测量方法 |
|------|--------|---------|
| 应用启动 | < 2s | 冷启动时间 |
| 解锁响应 | < 500ms | 输入密码到进入主界面 |
| 列表加载 | < 100ms | 100 条记录 |
| 搜索响应 | < 200ms | 全文搜索 |
| 同步时间 | < 5s | 1MB 数据 |

### 4.2 性能优化策略

```mermaid
graph TB
    subgraph "性能优化"
        Lazy[懒加载]
        Cache[缓存策略]
        Index[索引优化]
        Crypto[加密优化]
    end
    
    subgraph "实现"
        L1[分页加载列表]
        L2[Riverpod 状态缓存]
        L3[Isar 复合索引]
        L4[异步加密]
    end
    
    Lazy --> L1
    Cache --> L2
    Index --> L3
    Crypto --> L4
```

---

## 五、安全架构

### 5.1 安全层次

```mermaid
graph TB
    subgraph "安全架构"
        L1[传输层安全]
        L2[存储层安全]
        L3[内存安全]
        L4[应用层安全]
    end
    
    subgraph "实现措施"
        M1[HTTPS 强制]
        M2[AES-256-GCM]
        M3[内存覆写]
        M4[生物识别]
    end
    
    L1 --> M1
    L2 --> M2
    L3 --> M3
    L4 --> M4
```

### 5.2 威胁建模

| 威胁 | 风险等级 | 缓解措施 |
|------|---------|---------|
| 暴力破解 | 高 | Argon2id 慢哈希 |
| 内存转储 | 中 | 敏感数据使用后清除 |
| 中间人攻击 | 中 | HTTPS + 证书固定 |
| 恶意插件 | 低 | CSP + 权限隔离 |

---

## 六、部署架构

### 6.1 客户端部署

```mermaid
graph TB
    subgraph "构建流水线"
        Source[源代码]
        Build[构建]
        Test[测试]
        Sign[签名]
        Dist[分发]
    end
    
    subgraph "目标平台"
        AppStore[App Store]
        PlayStore[Play Store]
        GitHub[GitHub Releases]
        Web[Web 托管]
    end
    
    Source --> Build
    Build --> Test
    Test --> Sign
    Sign --> Dist
    Dist --> AppStore
    Dist --> PlayStore
    Dist --> GitHub
    Dist --> Web
```

### 6.2 版本策略

| 版本类型 | 格式 | 示例 | 说明 |
|---------|------|------|------|
| 主版本 | x.0.0 | 1.0.0 | 重大更新，可能不兼容 |
| 次版本 | x.y.0 | 1.1.0 | 新功能，向后兼容 |
| 修订版本 | x.y.z | 1.1.1 | Bug 修复 |

---

## 七、相关文档

- [整体架构](../02-架构设计/整体架构.md)
- [安全架构](../02-架构设计/安全架构.md)
- [技术栈](../01-项目概览/技术栈.md)

---

## 八、变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2026-02-20 | 初始版本 | Vaultly Team |
