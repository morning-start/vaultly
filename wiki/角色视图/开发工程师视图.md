# 开发工程师视图

> 为开发工程师提供的模块接口、数据结构、实现指南

---

## 一、项目结构

### 1.1 目录结构

```
vaultly/
├── lib/
│   ├── core/                      # 核心模块
│   │   ├── crypto/               # 加密相关
│   │   ├── models/               # 共享数据模型
│   │   └── utils/                # 工具函数
│   │
│   ├── data/                      # 数据层
│   │   ├── repositories/         # 数据仓库
│   │   ├── datasources/          # 数据源
│   │   └── providers/            # 数据提供者
│   │
│   ├── domain/                    # 领域层
│   │   ├── services/             # 业务服务
│   │   └── entities/             # 领域实体
│   │
│   ├── features/                  # 功能模块
│   │   ├── auth/                 # 认证模块
│   │   ├── vault/                # 保险库模块
│   │   ├── sync/                 # 同步模块
│   │   └── totp/                 # TOTP 模块
│   │
│   └── app/                       # 应用入口
│       ├── app.dart
│       └── main.dart
│
├── test/                          # 测试
│   ├── unit/                     # 单元测试
│   ├── integration/              # 集成测试
│   └── e2e/                      # 端到端测试
│
└── extensions/                    # 浏览器插件
    └── browser/
```

### 1.2 模块结构示例

```
lib/features/auth/
├── data/
│   ├── models/
│   │   └── vault_metadata_model.dart
│   ├── repositories/
│   │   └── auth_repository_impl.dart
│   └── datasources/
│       ├── local_auth_datasource.dart
│       └── secure_storage_datasource.dart
├── domain/
│   ├── entities/
│   │   ├── vault_metadata.dart
│   │   └── auth_session.dart
│   ├── repositories/
│   │   └── auth_repository.dart
│   └── services/
│       ├── auth_service.dart
│       └── crypto_service.dart
└── presentation/
    ├── providers/
    │   └── auth_provider.dart
    ├── screens/
    │   ├── setup_screen.dart
    │   └── unlock_screen.dart
    └── widgets/
        ├── password_input.dart
        └── biometric_button.dart
```

---

## 二、核心接口

### 2.1 认证服务接口

```dart
// lib/features/auth/domain/services/auth_service.dart

abstract class AuthService {
  /// 检查是否已初始化
  Future<bool> isInitialized();
  
  /// 首次设置主密码
  Future<SetupResult> setupMasterPassword(String password);
  
  /// 使用主密码解锁
  Future<AuthResult> unlockWithPassword(String password);
  
  /// 使用生物识别解锁
  Future<AuthResult> unlockWithBiometric();
  
  /// 锁定应用
  Future<void> lock();
  
  /// 修改主密码
  Future<ChangePasswordResult> changeMasterPassword(
    String currentPassword,
    String newPassword,
  );
  
  /// 状态流
  Stream<AuthState> get authStateStream;
  
  /// 当前状态
  AuthState get currentState;
  
  /// 是否已解锁
  bool get isUnlocked;
  
  /// 获取加密密钥（用于数据加密）
  Future<Uint8List?> getEncryptionKey();
}

/// 认证结果
enum AuthResult {
  success,
  failure,
  lockedOut,
  biometricsNotAvailable,
  biometricsNotEnabled,
  error,
}
```

### 2.2 保险库服务接口

```dart
// lib/features/vault/domain/services/vault_service.dart

abstract class VaultService {
  /// CRUD 操作
  Future<VaultEntry> addEntry(VaultEntry entry);
  Future<VaultEntry> updateEntry(VaultEntry entry);
  Future<void> deleteEntry(String id);
  Future<VaultEntry?> getEntry(String id);
  Future<List<VaultEntry>> getAllEntries();
  
  /// 搜索
  Future<List<VaultEntry>> searchEntries(
    String query, {
    List<EntryType>? types,
    List<String>? tags,
    bool? favoritesOnly,
  });
  
  /// 标签管理
  Future<List<String>> getAllTags();
  Future<void> addTag(String entryId, String tag);
  Future<void> removeTag(String entryId, String tag);
  
  /// 密码生成
  String generatePassword({
    int length = 16,
    bool includeUppercase = true,
    bool includeLowercase = true,
    bool includeNumbers = true,
    bool includeSpecial = true,
  });
}
```

### 2.3 同步服务接口

```dart
// lib/features/sync/domain/services/sync_service.dart

abstract class SyncService {
  /// 配置管理
  Future<void> saveConfig(SyncConfig config);
  Future<SyncConfig?> getConfig();
  
  /// 连接测试
  Future<ConnectionResult> testConnection(SyncConfig config);
  
  /// 同步操作
  Future<SyncResult> sync();
  Future<SyncResult> syncUpload();
  Future<SyncResult> syncDownload();
  
  /// 状态查询
  Stream<SyncState> get syncStateStream;
  SyncState get currentState;
  bool get isSyncing;
  
  /// 冲突解决
  Future<void> resolveConflict(String entryId, ConflictResolution resolution);
}

enum ConflictResolution {
  keepLocal,
  keepRemote,
  merge,
  skip,
}
```

---

## 三、数据模型

### 3.1 核心实体

```dart
// lib/core/models/vault_entry.dart

/// 保险库条目基类
abstract class VaultEntry {
  final String id;
  final String title;
  final EntryType type;
  final DateTime createdAt;
  final DateTime updatedAt;
  final bool isArchived;
  final bool isFavorite;
  final List<String> tags;
  final EncryptedData encryptedData;
  
  VaultEntry({
    required this.id,
    required this.title,
    required this.type,
    required this.createdAt,
    required this.updatedAt,
    this.isArchived = false,
    this.isFavorite = false,
    this.tags = const [],
    required this.encryptedData,
  });
}

enum EntryType {
  login,
  bankCard,
  secureNote,
  identity,
}

/// 加密数据
class EncryptedData {
  final String cipherText;
  final String iv;
  final String authTag;
  final int version;
  
  EncryptedData({
    required this.cipherText,
    required this.iv,
    required this.authTag,
    this.version = 1,
  });
}
```

### 3.2 登录凭证

```dart
// lib/features/vault/domain/entities/login_entry.dart

class LoginEntry extends VaultEntry {
  final String? url;
  final String? username;
  final String? email;
  
  LoginEntry({
    required super.id,
    required super.title,
    required super.createdAt,
    required super.updatedAt,
    required super.encryptedData,
    this.url,
    this.username,
    this.email,
    super.isArchived,
    super.isFavorite,
    super.tags,
  }) : super(type: EntryType.login);
  
  /// 解密后的敏感数据
  LoginSensitiveData? get sensitiveData => _decrypt();
}

class LoginSensitiveData {
  final String password;
  final String? totpSecret;
  final String? notes;
  
  LoginSensitiveData({
    required this.password,
    this.totpSecret,
    this.notes,
  });
}
```

---

## 四、状态管理

### 4.1 Riverpod Provider 示例

```dart
// lib/features/auth/presentation/providers/auth_provider.dart

import 'package:flutter_riverpod/flutter_riverpod.dart';

/// 认证服务 Provider
final authServiceProvider = Provider<AuthService>((ref) {
  return AuthServiceImpl(
    repository: ref.watch(authRepositoryProvider),
    cryptoService: ref.watch(cryptoServiceProvider),
  );
});

/// 认证状态 Provider
final authStateProvider = StreamProvider<AuthState>((ref) {
  final authService = ref.watch(authServiceProvider);
  return authService.authStateStream;
});

/// 当前认证状态 Provider
final currentAuthStateProvider = Provider<AuthState>((ref) {
  final authService = ref.watch(authServiceProvider);
  return authService.currentState;
});

/// 是否已解锁 Provider
final isUnlockedProvider = Provider<bool>((ref) {
  final authService = ref.watch(authServiceProvider);
  return authService.isUnlocked;
});
```

### 4.2 状态通知器示例

```dart
// lib/features/vault/presentation/providers/vault_notifier.dart

class VaultNotifier extends StateNotifier<VaultState> {
  final VaultService _vaultService;
  
  VaultNotifier(this._vaultService) : super(VaultState.initial());
  
  Future<void> loadEntries() async {
    state = state.copyWith(isLoading: true);
    
    try {
      final entries = await _vaultService.getAllEntries();
      state = state.copyWith(
        entries: entries,
        isLoading: false,
      );
    } catch (e) {
      state = state.copyWith(
        error: e.toString(),
        isLoading: false,
      );
    }
  }
  
  Future<void> addEntry(VaultEntry entry) async {
    try {
      final newEntry = await _vaultService.addEntry(entry);
      state = state.copyWith(
        entries: [...state.entries, newEntry],
      );
    } catch (e) {
      state = state.copyWith(error: e.toString());
    }
  }
}

/// VaultNotifier Provider
final vaultNotifierProvider = StateNotifierProvider<VaultNotifier, VaultState>((ref) {
  return VaultNotifier(ref.watch(vaultServiceProvider));
});
```

---

## 五、依赖注入

### 5.1 服务注册

```dart
// lib/core/di/service_locator.dart

import 'package:get_it/get_it.dart';

final getIt = GetIt.instance;

void setupDependencies() {
  // 核心服务
  getIt.registerLazySingleton<CryptoService>(
    () => CryptoServiceImpl(),
  );
  
  // 数据层
  getIt.registerLazySingleton<AuthRepository>(
    () => AuthRepositoryImpl(
      isar: getIt(),
      secureStorage: getIt(),
    ),
  );
  
  // 领域层
  getIt.registerLazySingleton<AuthService>(
    () => AuthServiceImpl(
      repository: getIt(),
      cryptoService: getIt(),
    ),
  );
}
```

---

## 六、错误处理

### 6.1 自定义异常

```dart
// lib/core/exceptions/app_exceptions.dart

abstract class AppException implements Exception {
  final String message;
  final String? code;
  
  AppException(this.message, {this.code});
  
  @override
  String toString() => '[$code] $message';
}

class AuthException extends AppException {
  AuthException(String message, {String? code}) 
    : super(message, code: code);
}

class CryptoException extends AppException {
  CryptoException(String message, {String? code}) 
    : super(message, code: code);
}

class SyncException extends AppException {
  SyncException(String message, {String? code}) 
    : super(message, code: code);
}
```

### 6.2 错误处理模式

```dart
Future<void> performOperation() async {
  try {
    await riskyOperation();
  } on AuthException catch (e) {
    // 处理认证错误
    _showAuthError(e);
  } on CryptoException catch (e) {
    // 处理加密错误
    _showCryptoError(e);
  } catch (e) {
    // 处理未知错误
    _showGenericError(e);
  }
}
```

---

## 七、测试指南

### 7.1 单元测试

```dart
// test/features/auth/auth_service_test.dart

import 'package:flutter_test/flutter_test.dart';
import 'package:mocktail/mocktail.dart';

class MockAuthRepository extends Mock implements AuthRepository {}
class MockCryptoService extends Mock implements CryptoService {}

void main() {
  late AuthService authService;
  late MockAuthRepository mockRepository;
  late MockCryptoService mockCrypto;
  
  setUp(() {
    mockRepository = MockAuthRepository();
    mockCrypto = MockCryptoService();
    authService = AuthServiceImpl(
      repository: mockRepository,
      cryptoService: mockCrypto,
    );
  });
  
  group('unlockWithPassword', () {
    test('should return success when password is correct', () async {
      // Arrange
      when(() => mockRepository.getMetadata())
          .thenAnswer((_) async => testMetadata);
      when(() => mockCrypto.deriveKey(any(), any(), any()))
          .thenAnswer((_) async => testDerivedKey);
      when(() => mockRepository.getEncryptedVaultKey())
          .thenAnswer((_) async => testEncryptedKey);
      when(() => mockCrypto.decrypt(any(), any()))
          .thenAnswer((_) async => testVaultKey);
      
      // Act
      final result = await authService.unlockWithPassword('correct_password');
      
      // Assert
      expect(result, equals(AuthResult.success));
    });
    
    test('should return failure when password is incorrect', () async {
      // Arrange
      when(() => mockRepository.getMetadata())
          .thenAnswer((_) async => testMetadata);
      when(() => mockCrypto.deriveKey(any(), any(), any()))
          .thenAnswer((_) async => testDerivedKeyWithWrongHash);
      
      // Act
      final result = await authService.unlockWithPassword('wrong_password');
      
      // Assert
      expect(result, equals(AuthResult.failure));
    });
  });
}
```

### 7.2 Widget 测试

```dart
// test/features/auth/unlock_screen_test.dart

void main() {
  testWidgets('should show unlock button', (tester) async {
    await tester.pumpWidget(
      ProviderScope(
        child: MaterialApp(
          home: UnlockScreen(),
        ),
      ),
    );
    
    expect(find.text('Unlock'), findsOneWidget);
    expect(find.byType(TextField), findsOneWidget);
  });
}
```

---

## 八、代码规范

### 8.1 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| 类名 | PascalCase | `AuthService`, `VaultEntry` |
| 方法名 | camelCase | `unlockWithPassword()` |
| 常量 | lowerCamelCase | `defaultTimeout` |
| 私有成员 | 前缀下划线 | `_sessionKey` |
| 文件 | snake_case | `auth_service.dart` |

### 8.2 注释规范

```dart
/// 认证服务接口
/// 
/// 负责处理用户认证相关的业务逻辑，包括：
/// - 主密码设置和验证
/// - 生物识别解锁
/// - 会话管理
abstract class AuthService {
  /// 使用主密码解锁保险库
  /// 
  /// [password] 用户输入的主密码
  /// 
  /// 返回 [AuthResult.success] 表示解锁成功
  /// 返回 [AuthResult.failure] 表示密码错误
  /// 
  /// 注意：密码不会被存储，仅用于派生密钥
  Future<AuthResult> unlockWithPassword(String password);
}
```

---

## 九、相关文档

- [用户认证需求文档](../需求文档/用户认证需求.md)
- [保险库管理需求文档](../需求文档/保险库管理需求.md)
- [认证状态机](../状态机/认证状态机.md)

---

## 十、变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2026-02-20 | 初始版本 | Vaultly Team |
