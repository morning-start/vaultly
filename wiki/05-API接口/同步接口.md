# 同步接口

> **版本**: v1.2.0  
> **更新日期**: 2026-02-22  
> **作者**: Vaultly Team  
> **文档类型**: API 文档

---

## 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-02-20 | 初始版本 | Vaultly Team |
| v1.1.0 | 2026-02-22 | 统一数据类型：SyncConfig、SyncState、SyncStatus、ConnectionResult | Vaultly Team |
| v1.2.0 | 2026-02-22 | 新增加密/压缩开关参数，支持用户选择是否加密 | Vaultly Team |

---

## 一、SyncService

### 1.1 配置管理

#### saveConfig

保存同步配置。

```dart
Future<void> saveConfig(SyncConfig config)
```

**参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| config | SyncConfig | 是 | 同步配置 |

**返回：** void

---

#### getConfig

获取同步配置。

```dart
Future<SyncConfig?> getConfig()
```

**返回：** SyncConfig? - 配置（如果存在）

---

#### testConnection

测试 WebDAV 连接。

```dart
Future<ConnectionResult> testConnection(SyncConfig config)
```

**参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| config | SyncConfig | 是 | 同步配置 |

**返回：** ConnectionResult - 连接结果（包含成功/失败状态和错误信息）

---

### 1.2 同步操作

#### sync

执行完整同步。

```dart
Future<SyncResult> sync()
```

**返回：** SyncResult
```dart
class SyncResult {
  bool success;
  int added;
  int updated;
  int deleted;
  List<Conflict> conflicts;
  DateTime timestamp;
  String? errorMessage;
}
```

---

#### upload

上传本地数据到远程。

```dart
Future<SyncResult> upload({
  required Uint8List encryptionKey,
  bool enableEncryption = true,    // 默认加密
  bool enableCompression = true,   // 默认压缩
  Function(double progress)? onProgress,
})
```

**参数：**
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| encryptionKey | Uint8List | 是 | - | 主密码派生的加密密钥 |
| enableEncryption | bool | 否 | true | 是否启用加密（默认加密）|
| enableCompression | bool | 否 | true | 是否启用压缩 |
| onProgress | Function | 否 | null | 进度回调 |

**返回：** SyncResult

**说明：**
- 当 `enableEncryption = true` 时：数据经过 AES-256-GCM 加密后再传输
- 当 `enableEncryption = false` 时：数据以原始 JSON 格式传输
- 压缩在加密之后进行（可选）

---

#### download

从远程下载数据。

```dart
Future<SyncResult> download({
  required Uint8List encryptionKey,
  bool enableEncryption = true,    // 默认加密
  bool enableCompression = true,   // 默认压缩
  Function(double progress)? onProgress,
})
```

**参数：**
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| encryptionKey | Uint8List | 是 | - | 主密码派生的加密密钥 |
| enableEncryption | bool | 否 | true | 数据是否加密（需与上传时一致）|
| enableCompression | bool | 否 | true | 数据是否压缩（需与上传时一致）|
| onProgress | Function | 否 | null | 进度回调 |

**返回：** SyncResult

---

### 1.3 状态管理

#### getSyncState

获取当前同步状态。

```dart
Future<SyncState> getSyncState()
```

**返回：** SyncState
```dart
class SyncState {
  final SyncStatus status;            // 当前状态
  final double progress;              // 进度（0-100）
  final String? currentOperation;     // 当前操作描述
  final DateTime? startedAt;          // 开始时间
  final DateTime? completedAt;        // 完成时间
  final DateTime? lastSyncAt;         // 最后同步时间
  final SyncError? error;             // 错误信息
  final List<Conflict>? conflicts;    // 冲突列表
}

enum SyncStatus {
  idle,           // 空闲
  checking,       // 检查中
  downloading,    // 下载中
  uploading,      // 上传中
  merging,        // 合并中
  conflicted,     // 冲突中
  resolving,      // 解决中
  success,        // 同步成功
  failure,        // 同步失败
}
```

---

#### getStatusStream

获取同步状态流。

```dart
Stream<SyncStatus> getStatusStream()
```

**返回：** Stream<SyncStatus>

---

## 二、ConflictResolver

### 2.1 冲突解决

#### resolveConflict

解决同步冲突。

```dart
Future<ConflictResolution> resolveConflict(
  Conflict conflict,
  ConflictResolutionStrategy strategy,
)
```

**参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| conflict | Conflict | 是 | 冲突信息 |
| strategy | ConflictResolutionStrategy | 是 | 解决策略 |

**返回：** ConflictResolution

**策略选项：**
- `keepLocal`: 保留本地版本
- `keepRemote`: 保留远程版本
- `merge`: 合并（如果支持）

---

#### getConflicts

获取所有未解决的冲突。

```dart
Future<List<Conflict>> getConflicts()
```

**返回：** List<Conflict> - 冲突列表

---

## 三、使用示例

### 3.1 配置同步

```dart
final syncService = SyncService();

final config = SyncConfig(
  id: 'sync_config_001',
  serverUrl: 'https://my-nas.com/remote.php/dav/',
  username: 'user',
  password: 'encrypted_password',
  remotePath: '/vaultly/',
  syncMode: SyncMode.auto,
  autoSyncInterval: Duration(minutes: 30),
  syncOnChange: true,
  syncOnStartup: true,
  isEnabled: true,
);

await syncService.saveConfig(config);
```

### 3.2 执行同步（加密模式，默认）

```dart
final syncService = SyncService();
final vaultData = await vaultRepository.getAllEntriesAsJson();

// 加密上传（默认）
final result = await syncService.upload(
  vaultData: vaultData,
  encryptionKey: derivedKey,        // 主密码派生的密钥
  enableEncryption: true,           // 默认加密
  enableCompression: true,          // 默认压缩
);

if (result.success) {
  print('加密同步成功');
}
```

### 3.3 执行同步（不加密模式）

```dart
final syncService = SyncService();
final vaultData = await vaultRepository.getAllEntriesAsJson();

// 不加密上传（明文 JSON）
final result = await syncService.upload(
  vaultData: vaultData,
  encryptionKey: derivedKey,        // 仍然需要密钥，但不使用
  enableEncryption: false,          // 不加密
  enableCompression: false,         // 不压缩
);

if (result.success) {
  print('明文同步成功');
}
```

### 3.4 下载同步数据

```dart
// 下载加密数据
final remoteData = await syncService.download(
  encryptionKey: derivedKey,
  enableEncryption: true,    // 数据是加密的
  enableCompression: true,  // 数据是压缩的
);

// 下载明文数据
final remoteData = await syncService.download(
  encryptionKey: derivedKey,
  enableEncryption: false,   // 数据是明文
  enableCompression: false,  // 数据未压缩
);
```

### 3.5 处理冲突

```dart
final syncService = SyncService();
final conflicts = await syncService.getConflicts();

for (final conflict in conflicts) {
  // 让用户选择解决策略
  final resolution = await showDialog<ConflictResolution>(
    context: context,
    builder: (context) => ConflictDialog(conflict),
  );
  
  await syncService.resolveConflict(
    conflict,
    resolution.strategy,
  );
}
```

---

## 四、相关文档

- [同步模块](../03-模块设计/同步模块.md) - 模块设计
- [同步架构](../02-架构设计/同步架构.md) - 同步架构
- [接口概览](./接口概览.md) - 接口概览
