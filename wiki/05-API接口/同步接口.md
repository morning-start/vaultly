# 同步接口

## 一、SyncService

### 1.1 配置管理

#### saveConfig

保存 WebDAV 配置。

```dart
Future<void> saveConfig(WebDAVConfig config)
```

**参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| config | WebDAVConfig | 是 | WebDAV 配置 |

**返回：** void

---

#### getConfig

获取 WebDAV 配置。

```dart
Future<WebDAVConfig?> getConfig()
```

**返回：** WebDAVConfig? - 配置（如果存在）

---

#### testConnection

测试 WebDAV 连接。

```dart
Future<bool> testConnection(WebDAVConfig config)
```

**参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| config | WebDAVConfig | 是 | WebDAV 配置 |

**返回：** bool - 连接是否成功

---

### 1.2 同步操作

#### sync

执行完整同步。

```dart
Future<SyncResult> sync()
```

**返回：** SyncResult
```dart
class SyncResult {
  bool success;
  int added;
  int updated;
  int deleted;
  List<Conflict> conflicts;
  DateTime timestamp;
  String? errorMessage;
}
```

---

#### upload

上传本地数据到远程。

```dart
Future<void> upload()
```

**返回：** void

---

#### download

从远程下载数据。

```dart
Future<void> download()
```

**返回：** void

---

### 1.3 状态管理

#### getSyncState

获取当前同步状态。

```dart
Future<SyncState> getSyncState()
```

**返回：** SyncState
```dart
class SyncState {
  SyncStatus status;
  DateTime? lastSyncTime;
  String? localHash;
  String? remoteHash;
  List<Conflict> conflicts;
  String? errorMessage;
}
```

---

#### getStatusStream

获取同步状态流。

```dart
Stream<SyncStatus> getStatusStream()
```

**返回：** Stream<SyncStatus>

---

## 二、ConflictResolver

### 2.1 冲突解决

#### resolveConflict

解决同步冲突。

```dart
Future<ConflictResolution> resolveConflict(
  Conflict conflict,
  ConflictResolutionStrategy strategy,
)
```

**参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| conflict | Conflict | 是 | 冲突信息 |
| strategy | ConflictResolutionStrategy | 是 | 解决策略 |

**返回：** ConflictResolution

**策略选项：**
- `keepLocal`: 保留本地版本
- `keepRemote`: 保留远程版本
- `merge`: 合并（如果支持）

---

#### getConflicts

获取所有未解决的冲突。

```dart
Future<List<Conflict>> getConflicts()
```

**返回：** List<Conflict> - 冲突列表

---

## 三、使用示例

### 3.1 配置 WebDAV

```dart
final syncService = SyncService();

final config = WebDAVConfig(
  serverUrl: 'https://my-nas.com/remote.php/dav/',
  username: 'user',
  password: 'encrypted_password',
  remotePath: '/vaultly/vault.enc',
  enableSync: true,
  syncInterval: 30,
);

await syncService.saveConfig(config);
```

### 3.2 执行同步

```dart
final syncService = SyncService();
final result = await syncService.sync();

if (result.success) {
  print('同步成功: +${result.added} -${result.deleted} ~${result.updated}');
} else {
  print('同步失败: ${result.errorMessage}');
}
```

### 3.3 处理冲突

```dart
final syncService = SyncService();
final conflicts = await syncService.getConflicts();

for (final conflict in conflicts) {
  // 让用户选择解决策略
  final resolution = await showDialog<ConflictResolution>(
    context: context,
    builder: (context) => ConflictDialog(conflict),
  );
  
  await syncService.resolveConflict(
    conflict,
    resolution.strategy,
  );
}
```

---

## 四、相关文档

- [同步模块](../03-模块设计/同步模块.md) - 模块设计
- [同步架构](../02-架构设计/同步架构.md) - 同步架构
- [接口概览](./接口概览.md) - 接口概览
