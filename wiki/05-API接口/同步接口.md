# 同步接口

> **版本**: v1.1.0  
> **更新日期**: 2026-02-22  
> **作者**: Vaultly Team  
> **文档类型**: API 文档

---

## 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-02-20 | 初始版本 | Vaultly Team |
| v1.1.0 | 2026-02-22 | 统一数据类型：SyncConfig、SyncState、SyncStatus、ConnectionResult | Vaultly Team |

---

## 一、SyncService

### 1.1 配置管理

#### saveConfig

保存同步配置。

```dart
Future<void> saveConfig(SyncConfig config)
```

**参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| config | SyncConfig | 是 | 同步配置 |

**返回：** void

---

#### getConfig

获取同步配置。

```dart
Future<SyncConfig?> getConfig()
```

**返回：** SyncConfig? - 配置（如果存在）

---

#### testConnection

测试 WebDAV 连接。

```dart
Future<ConnectionResult> testConnection(SyncConfig config)
```

**参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| config | SyncConfig | 是 | 同步配置 |

**返回：** ConnectionResult - 连接结果（包含成功/失败状态和错误信息）

---

### 1.2 同步操作

#### sync

执行完整同步。

```dart
Future<SyncResult> sync()
```

**返回：** SyncResult
```dart
class SyncResult {
  bool success;
  int added;
  int updated;
  int deleted;
  List<Conflict> conflicts;
  DateTime timestamp;
  String? errorMessage;
}
```

---

#### upload

上传本地数据到远程。

```dart
Future<void> upload()
```

**返回：** void

---

#### download

从远程下载数据。

```dart
Future<void> download()
```

**返回：** void

---

### 1.3 状态管理

#### getSyncState

获取当前同步状态。

```dart
Future<SyncState> getSyncState()
```

**返回：** SyncState
```dart
class SyncState {
  final SyncStatus status;            // 当前状态
  final double progress;              // 进度（0-100）
  final String? currentOperation;     // 当前操作描述
  final DateTime? startedAt;          // 开始时间
  final DateTime? completedAt;        // 完成时间
  final DateTime? lastSyncAt;         // 最后同步时间
  final SyncError? error;             // 错误信息
  final List<Conflict>? conflicts;    // 冲突列表
}

enum SyncStatus {
  idle,           // 空闲
  checking,       // 检查中
  downloading,    // 下载中
  uploading,      // 上传中
  merging,        // 合并中
  conflicted,     // 冲突中
  resolving,      // 解决中
  success,        // 同步成功
  failure,        // 同步失败
}
```

---

#### getStatusStream

获取同步状态流。

```dart
Stream<SyncStatus> getStatusStream()
```

**返回：** Stream<SyncStatus>

---

## 二、ConflictResolver

### 2.1 冲突解决

#### resolveConflict

解决同步冲突。

```dart
Future<ConflictResolution> resolveConflict(
  Conflict conflict,
  ConflictResolutionStrategy strategy,
)
```

**参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| conflict | Conflict | 是 | 冲突信息 |
| strategy | ConflictResolutionStrategy | 是 | 解决策略 |

**返回：** ConflictResolution

**策略选项：**
- `keepLocal`: 保留本地版本
- `keepRemote`: 保留远程版本
- `merge`: 合并（如果支持）

---

#### getConflicts

获取所有未解决的冲突。

```dart
Future<List<Conflict>> getConflicts()
```

**返回：** List<Conflict> - 冲突列表

---

## 三、使用示例

### 3.1 配置同步

```dart
final syncService = SyncService();

final config = SyncConfig(
  id: 'sync_config_001',
  serverUrl: 'https://my-nas.com/remote.php/dav/',
  username: 'user',
  password: 'encrypted_password',
  remotePath: '/vaultly/',
  syncMode: SyncMode.auto,
  autoSyncInterval: Duration(minutes: 30),
  syncOnChange: true,
  syncOnStartup: true,
  isEnabled: true,
);

await syncService.saveConfig(config);
```

### 3.2 执行同步

```dart
final syncService = SyncService();
final result = await syncService.sync();

if (result.success) {
  print('同步成功: +${result.added} -${result.deleted} ~${result.updated}');
} else {
  print('同步失败: ${result.errorMessage}');
}
```

### 3.3 处理冲突

```dart
final syncService = SyncService();
final conflicts = await syncService.getConflicts();

for (final conflict in conflicts) {
  // 让用户选择解决策略
  final resolution = await showDialog<ConflictResolution>(
    context: context,
    builder: (context) => ConflictDialog(conflict),
  );
  
  await syncService.resolveConflict(
    conflict,
    resolution.strategy,
  );
}
```

---

## 四、相关文档

- [同步模块](../03-模块设计/同步模块.md) - 模块设计
- [同步架构](../02-架构设计/同步架构.md) - 同步架构
- [接口概览](./接口概览.md) - 接口概览
