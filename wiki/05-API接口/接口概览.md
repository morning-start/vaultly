# 接口概览

> **版本**: v1.1.0  
> **更新日期**: 2026-02-20  
> **作者**: Vaultly Team  
> **文档体系**: 渐进式文档（project-wiki）

---

## 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-02-20 | 初始版本 | Vaultly Team |
| v1.1.0 | 2026-02-20 | 补充代码实现映射、完善接口分类 | Vaultly Team |

---

## 一、接口清单

### 1.1 服务接口分类

| 分类 | 数量 | 说明 |
|------|------|------|
| **认证接口** | 8 | 登录、解锁、会话管理 |
| **保险库接口** | 15 | 条目 CRUD、搜索 |
| **TOTP 接口** | 6 | TOTP 生成、验证 |
| **同步接口** | 10 | WebDAV 同步管理 |
| **设置接口** | 8 | 应用设置 |

### 1.2 接口访问控制

| 接口类型 | 访问要求 |
|---------|----------|
| 认证接口 | 无需认证 |
| 保险库接口 | 需要解锁会话 |
| TOTP 接口 | 需要解锁会话 |
| 同步接口 | 需要解锁会话 |
| 设置接口 | 需要解锁会话 |

---

## 二、接口规范

### 2.1 RESTful 风格

内部服务接口使用 Dart 方法调用，遵循以下规范：

```dart
// 命名规范
class VaultService {
  // CRUD 操作
  Future<VaultEntry> getEntry(String id);
  Future<String> addEntry(VaultEntry entry);
  Future<void> updateEntry(VaultEntry entry);
  Future<void> deleteEntry(String id);
  
  // 查询操作
  Future<List<VaultEntry>> getAllEntries();
  Future<List<VaultEntry>> searchEntries(String query);
}
```

### 2.2 返回类型

| 类型 | 说明 |
|------|------|
| void | 操作成功，无返回值 |
| Future\<T\> | 异步返回 |
| Stream\<T\> | 流式返回（如同步状态） |

---

## 三、错误处理

### 3.1 异常类型

```dart
class VaultException implements Exception {
  final String message;
  final VaultErrorCode code;
  final dynamic details;
}

enum VaultErrorCode {
  // 认证错误
  invalidPassword,
  tooManyAttempts,
  vaultLocked,
  
  // 数据错误
  entryNotFound,
  invalidEntry,
  encryptionFailed,
  decryptionFailed,
  
  // 同步错误
  syncFailed,
  conflictDetected,
  networkError,
  
  // 通用错误
  unknown,
}
```

### 3.2 错误响应

```dart
class Result<T> {
  final T? data;
  final VaultException? error;
  final bool isSuccess;
  
  factory Result.success(T data) => Result._(data, null, true);
  factory Result.failure(VaultException error) => Result._(null, error, false);
}
```

---

## 四、代码实现映射

### 4.1 服务接口实现

| 接口文档 | 实现文件 | 关键类 |
|----------|----------|--------|
| **认证接口** | `lib/core/crypto/services/auth_service.dart` | `AuthService` |
| **生物识别接口** | `lib/core/services/biometric_service.dart` | `BiometricService` |
| **保险库接口** | `lib/core/services/vault_service.dart` | `VaultService` |
| **TOTP 接口** | `lib/core/services/totp_service.dart` | `TOTPService` |
| **同步接口** | `lib/core/services/webdav_service.dart` | `WebDAVService` |
| **自动锁定接口** | `lib/core/services/auto_lock_service.dart` | `AutoLockService` |

### 4.2 异常实现

```dart
// lib/core/exceptions/vault_exception.dart
class VaultException implements Exception {
  final String message;
  final VaultErrorCode code;
  final dynamic details;

  VaultException({
    required this.message,
    required this.code,
    this.details,
  });

  @override
  String toString() => 'VaultException: $message (code: $code)';
}

enum VaultErrorCode {
  // 认证错误
  invalidPassword,
  tooManyAttempts,
  vaultLocked,
  
  // 数据错误
  entryNotFound,
  invalidEntry,
  encryptionFailed,
  decryptionFailed,
  
  // 同步错误
  syncFailed,
  conflictDetected,
  networkError,
  
  // 通用错误
  unknown,
}
```

### 4.3 结果类型实现

```dart
// lib/core/result/result.dart
sealed class Result<T> {
  const Result();
  
  factory Result.success(T data) = Success<T>;
  factory Result.failure(VaultException error) = Failure<T>;
  
  bool get isSuccess => this is Success<T>;
  bool get isFailure => this is Failure<T>;
  
  T? get data => isSuccess ? (this as Success<T>).data : null;
  VaultException? get error => isFailure ? (this as Failure<T>).error : null;
}

class Success<T> extends Result<T> {
  final T data;
  const Success(this.data);
}

class Failure<T> extends Result<T> {
  final VaultException error;
  const Failure(this.error);
}

// 扩展方法
extension ResultExtension<T> on Result<T> {
  R when<R>({
    required R Function(T data) success,
    required R Function(VaultException error) failure,
  }) {
    return switch (this) {
      Success<T>(data: final d) => success(d),
      Failure<T>(error: final e) => failure(e),
      _ => throw StateError('Invalid Result state'),
    };
  }
}
```

---

## 五、相关文档

### 5.1 接口文档
- [认证接口](./认证接口.md) - 认证服务接口
- [保险库接口](./保险库接口.md) - 保险库服务接口
- [同步接口](./同步接口.md) - 同步服务接口

### 5.2 架构设计
- [整体架构](../02-架构设计/整体架构.md) - 系统架构
- [安全架构](../02-架构设计/安全架构.md) - 安全设计

### 5.3 模块设计
- [认证模块](../03-模块设计/认证模块.md) - 认证模块设计
- [保险库模块](../03-模块设计/保险库模块.md) - 保险库模块设计
- [TOTP 模块](../03-模块设计/TOTP模块.md) - TOTP 模块设计
