# 保险库管理需求文档

> 需求文档 - 定义保险库管理的数据模型、数据流动、状态管理、接口设计

---

## 一、数据模型

### 1.1 核心实体

#### VaultEntry（基础条目）

```dart
abstract class VaultEntry {
  // 基础信息
  final String id;                    // 唯一标识 (UUID)
  final String title;                 // 条目标题
  final EntryType type;               // 条目类型
  final DateTime createdAt;           // 创建时间
  final DateTime updatedAt;           // 最后更新时间
  final bool isArchived;              // 是否归档
  final bool isFavorite;              // 是否收藏
  
  // 分类信息
  final List<String> tags;            // 标签列表
  final String? folderId;             // 所属文件夹
  
  // 自定义字段
  final List<CustomField> customFields;
  
  // 加密数据（JSON 字符串，加密存储）
  final EncryptedData encryptedData;
}

enum EntryType {
  login,      // 登录凭证
  bankCard,   // 银行卡
  secureNote, // 安全笔记
  identity,   // 身份信息
}
```

#### LoginEntry（登录凭证）

```dart
class LoginEntry extends VaultEntry {
  // 非敏感信息（明文存储）
  final String? url;                  // 网站 URL
  final String? username;             // 用户名（可选明文）
  final String? email;                // 邮箱
  
  // 敏感信息（加密存储在 encryptedData）
  // - password: String
  // - totpSecret: String?
  // - notes: String?
  // - securityQuestions: List<Map>?
}
```

#### BankCardEntry（银行卡）

```dart
class BankCardEntry extends VaultEntry {
  // 非敏感信息
  final String cardHolderName;        // 持卡人
  final int expiryMonth;              // 有效期月
  final int expiryYear;               // 有效期年
  final CardType cardType;            // 卡类型
  final String? bankName;             // 银行名称
  
  // 敏感信息（加密存储）
  // - cardNumber: String
  // - cvv: String
}

enum CardType {
  visa,
  mastercard,
  amex,
  unionPay,
  other,
}
```

#### SecureNoteEntry（安全笔记）

```dart
class SecureNoteEntry extends VaultEntry {
  final bool isMarkdown;              // 是否 Markdown
  
  // 敏感信息（加密存储）
  // - content: String
}
```

#### IdentityEntry（身份信息）

```dart
class IdentityEntry extends VaultEntry {
  // 非敏感信息
  final String? firstName;
  final String? lastName;
  final String? middleName;
  final DateTime? birthDate;
  final String? phone;
  final String? email;
  final String? address;
  
  // 敏感信息（加密存储）
  // - idNumber: String (身份证号/护照号等)
  // - additionalInfo: Map
}
```

#### CustomField（自定义字段）

```dart
class CustomField {
  final String id;
  final String name;                  // 字段名称
  final FieldType type;               // 字段类型
  final String value;                 // 字段值（加密存储）
  final bool isSecret;                // 是否敏感
}

enum FieldType {
  text,       // 文本
  hidden,     // 隐藏（密码等）
  date,       // 日期
  url,        // URL
  email,      // 邮箱
  phone,      // 电话
}
```

### 1.2 数据字典

| 字段名 | 类型 | 长度 | 必填 | 说明 |
|--------|------|------|------|------|
| id | String | 36 | ✅ | UUID v4 |
| title | String | 256 | ✅ | 条目标题 |
| type | Enum | - | ✅ | 条目类型 |
| createdAt | DateTime | - | ✅ | 创建时间 |
| updatedAt | DateTime | - | ✅ | 更新时间 |
| isArchived | Bool | - | ✅ | 默认 false |
| isFavorite | Bool | - | ✅ | 默认 false |
| tags | List<String> | - | ❌ | 标签数组 |
| encryptedData | JSON | - | ✅ | 加密后的敏感数据 |

---

## 二、数据流动

### 2.1 添加条目数据流

```mermaid
sequenceDiagram
    participant User as 用户
    participant UI as 添加界面
    participant VaultService as 保险库服务
    participant CryptoService as 加密服务
    participant Isar as 本地数据库

    User->>UI: 填写条目信息
    UI->>UI: 表单验证
    
    alt 验证失败
        UI-->>User: 显示错误提示
    else 验证成功
        User->>UI: 点击保存
        UI->>VaultService: addEntry(entry)
        
        VaultService->>VaultService: 分离敏感/非敏感字段
        
        VaultService->>CryptoService: encrypt(sensitiveData, vaultKey)
        CryptoService-->>VaultService: encryptedData
        
        VaultService->>Isar: 保存条目
        Note over Isar: 存储：<br/>- 非敏感字段明文<br/>- 敏感字段密文
        
        Isar-->>VaultService: 保存成功
        VaultService-->>UI: 成功响应
        UI-->>User: 返回列表，显示新条目
    end
```

### 2.2 查看条目数据流

```mermaid
sequenceDiagram
    participant User as 用户
    participant UI as 列表界面
    participant DetailUI as 详情界面
    participant VaultService as 保险库服务
    participant CryptoService as 加密服务
    participant Isar as 本地数据库

    User->>UI: 点击条目
    UI->>VaultService: getEntry(id)
    
    VaultService->>Isar: 查询条目
    Isar-->>VaultService: entry (encryptedData)
    
    VaultService->>CryptoService: decrypt(encryptedData, vaultKey)
    CryptoService-->>VaultService: sensitiveData
    
    VaultService->>VaultService: 合并数据
    VaultService-->>DetailUI: 完整条目
    
    DetailUI-->>User: 显示条目详情
    
    opt 复制敏感信息
        User->>DetailUI: 点击复制密码
        DetailUI->>DetailUI: 复制到剪贴板
        DetailUI->>DetailUI: 启动定时清除
    end
```

### 2.3 搜索条目数据流

```mermaid
sequenceDiagram
    participant User as 用户
    participant UI as 搜索界面
    participant VaultService as 保险库服务
    participant Isar as 本地数据库

    User->>UI: 输入搜索关键词
    UI->>VaultService: searchEntries(query, filters)
    
    VaultService->>Isar: 查询非敏感字段
    Note over Isar: 搜索字段：<br/>- title<br/>- username<br/>- url<br/>- tags
    
    Isar-->>VaultService: 匹配条目列表
    
    alt 需要搜索加密字段
        VaultService->>VaultService: 解密并搜索
        Note over VaultService: 性能考虑：<br/>仅当必要时解密
    end
    
    VaultService->>VaultService: 应用筛选器
    Note over VaultService: 筛选条件：<br/>- 标签<br/>- 类型<br/>- 收藏
    
    VaultService-->>UI: 搜索结果
    UI-->>User: 显示结果列表
```

### 2.4 编辑条目数据流

```mermaid
sequenceDiagram
    participant User as 用户
    participant UI as 编辑界面
    participant VaultService as 保险库服务
    participant CryptoService as 加密服务
    participant Isar as 本地数据库

    User->>UI: 修改条目信息
    UI->>VaultService: updateEntry(updatedEntry)
    
    VaultService->>Isar: 获取原条目
    Isar-->>VaultService: originalEntry
    
    VaultService->>VaultService: 比较变更
    
    alt 敏感字段变更
        VaultService->>CryptoService: encrypt(newSensitiveData, vaultKey)
        CryptoService-->>VaultService: newEncryptedData
    end
    
    VaultService->>Isar: 更新条目
    Note over Isar: 更新：<br/>- 非敏感字段<br/>- encryptedData<br/>- updatedAt
    
    Isar-->>VaultService: 更新成功
    VaultService-->>UI: 成功响应
    UI-->>User: 返回详情页
```

---

## 三、状态管理

### 3.1 条目状态机

```mermaid
stateDiagram-v2
    [*] --> 正常: 创建条目
    
    正常 --> 编辑中: 开始编辑
    编辑中 --> 正常: 保存成功
    编辑中 --> 正常: 取消编辑
    
    正常 --> 已归档: 归档
    已归档 --> 正常: 恢复
    
    正常 --> 已删除: 删除
    已归档 --> 已删除: 删除
    
    已删除 --> [*]: 永久删除
    已删除 --> 正常: 恢复（30天内）
```

### 3.2 状态定义

| 状态 | 说明 | 可见性 | 保留期限 |
|------|------|--------|---------|
| 正常 | 活跃条目 | 默认列表 | 永久 |
| 编辑中 | 正在编辑 | 编辑界面 | - |
| 已归档 | 不再使用但保留 | 归档文件夹 | 永久 |
| 已删除 | 软删除 | 回收站 | 30天 |

### 3.3 保险库整体状态

```mermaid
stateDiagram-v2
    [*] --> 加载中: 应用启动
    加载中 --> 空保险库: 无条目
    加载中 --> 有数据: 有条目
    
    空保险库 --> 有数据: 添加首个条目
    
    有数据 --> 搜索中: 开始搜索
    搜索中 --> 有数据: 清空搜索
    
    有数据 --> 筛选中: 应用筛选
    筛选中 --> 有数据: 清除筛选
    
    有数据 --> 空保险库: 删除所有条目
```

---

## 四、接口设计

### 4.1 VaultService 接口

```dart
abstract class VaultService {
  // CRUD 操作
  Future<VaultEntry> addEntry(VaultEntry entry);
  Future<VaultEntry> updateEntry(VaultEntry entry);
  Future<void> deleteEntry(String id);
  Future<VaultEntry?> getEntry(String id);
  Future<List<VaultEntry>> getAllEntries();
  
  // 搜索与筛选
  Future<List<VaultEntry>> searchEntries(
    String query, {
    List<EntryType>? types,
    List<String>? tags,
    bool? favoritesOnly,
    bool? includeArchived,
  });
  
  // 批量操作
  Future<void> deleteEntries(List<String> ids);
  Future<void> archiveEntries(List<String> ids);
  Future<void> favoriteEntries(List<String> ids, bool favorite);
  
  // 标签管理
  Future<List<String>> getAllTags();
  Future<void> addTag(String entryId, String tag);
  Future<void> removeTag(String entryId, String tag);
  
  // 密码生成
  String generatePassword({
    int length = 16,
    bool includeUppercase = true,
    bool includeLowercase = true,
    bool includeNumbers = true,
    bool includeSpecial = true,
  });
  
  // 复制功能
  Future<void> copyToClipboard(String text, {Duration? clearAfter});
  
  // 导入/导出
  Future<ImportResult> importFromFile(String filePath, ImportFormat format);
  Future<String> exportToFile(ExportFormat format);
}
```

### 4.2 结果类型定义

```dart
enum ImportResult {
  success,
  partialSuccess,    // 部分导入成功
  invalidFormat,     // 格式错误
  decryptionFailed,  // 解密失败
  error,
}

enum ImportFormat {
  json,
  csv,
  bitwarden,
  onePassword,
}

enum ExportFormat {
  encryptedJson,     // 加密 JSON
  plainJson,         // 明文 JSON（警告）
}
```

---

## 五、缓存策略

### 5.1 内存缓存

| 数据 | 缓存位置 | 策略 | 说明 |
|------|---------|------|------|
| 条目列表 | Riverpod State | 解锁期间保持 | 实时更新 |
| 搜索结果 | 临时缓存 | 搜索词变化时更新 | 避免重复搜索 |
| 当前查看条目 | 内存 | 离开详情页清除 | 安全考虑 |
| 标签列表 | Riverpod State | 变更时更新 | 不频繁变更 |

### 5.2 存储策略

| 数据 | 存储位置 | 格式 |
|------|---------|------|
| 条目元数据 | Isar | 明文 |
| 敏感数据 | Isar (encryptedData) | AES-256-GCM 加密 |
| 标签 | Isar | 明文 |
| 搜索索引 | Isar | 明文（仅非敏感字段）|

---

## 六、安全考虑

### 6.1 数据加密策略

```mermaid
graph TB
    subgraph "数据分类"
        Public[非敏感数据<br/>明文存储]
        Sensitive[敏感数据<br/>加密存储]
    end
    
    subgraph "非敏感数据"
        Title[标题]
        URL[URL]
        Tags[标签]
        Type[类型]
        Meta[元数据]
    end
    
    subgraph "敏感数据"
        Password[密码]
        CardNumber[卡号]
        CVV[CVV]
        TOTP[TOTP密钥]
        Notes[备注]
    end
    
    Public --> Title
    Public --> URL
    Public --> Tags
    Public --> Type
    Public --> Meta
    
    Sensitive --> Password
    Sensitive --> CardNumber
    Sensitive --> CVV
    Sensitive --> TOTP
    Sensitive --> Notes
```

### 6.2 安全措施

| 措施 | 实现 | 优先级 |
|------|------|--------|
| 字段级加密 | 敏感字段单独加密 | P0 |
| 内存保护 | 解密数据使用后清除 | P0 |
| 剪贴板保护 | 30秒自动清除 | P0 |
| 防截屏 | FLAG_SECURE | P1 |
| 自动锁定 | 闲置后锁定 | P1 |

---

## 七、相关文档

- [保险库管理功能文档](../功能文档/保险库管理功能.md) - 功能需求、用户场景
- [保险库管理架构文档](../架构文档/保险库管理架构.md) - 技术选型、实现方案
- [保险库数据流](../数据流动/保险库CRUD数据流.md) - 数据流动设计
- [数据字典](../04-数据模型/数据字典.md) - 核心数据结构

---

## 八、变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2026-02-20 | 初始版本 | Vaultly Team |
