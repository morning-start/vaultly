# 插件架构

> **版本**: v1.0.0  
> **更新日期**: 2026-02-20  
> **作者**: Vaultly Team  
> **文档类型**: 架构文档

---

## 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-02-20 | 初始版本 | Vaultly Team |

---

## 一、插件概述

### 1.1 插件目标

| 目标 | 描述 |
|------|------|
| **自动填充** | 自动填充登录表单 |
| **快速保存** | 一键保存新账号 |
| **密码生成** | 内置强密码生成器 |
| **快速访问** | 快速搜索和访问保险库 |

### 1.2 支持的浏览器

| 浏览器 | 支持 |
|--------|------|
| Chrome | ✅ |
| Firefox | ✅ |
| Edge | ✅ |
| Safari | ⚠️ 有限支持 |

---

## 二、技术选型

### 2.1 WXT 框架

WXT 是一个现代、轻量的浏览器扩展开发框架，基于原生 Manifest V3。

```bash
# 创建 WXT 项目
npx wxt init vaultly-browser
```

### 2.2 技术栈

| 技术 | 用途 |
|------|------|
| WXT | 插件框架 |
| TypeScript | 开发语言 |
| Vue/React | UI 框架 |
| chrome.storage | 本地存储 |

---

## 三、插件架构

### 3.1 架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           WXT 浏览器插件架构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                      Popup (弹出窗口)                            │      │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │      │
│   │   │  Quick   │  │  Search  │  │  Generate │  │   Settings   │  │      │
│   │   │  Access  │  │   Vault  │  │  Password │  │              │  │      │
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────────┘  │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                      Background Script                          │      │
│   │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │      │
│   │   │  Vault       │  │   AutoFill   │  │   Message    │          │      │
│   │   │  Manager     │  │   Handler    │  │   Bridge     │          │      │
│   │   └──────────────┘  └──────────────┘  └──────────────┘          │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                      Content Script                             │      │
│   │   ┌──────────────┐  ┌──────────────┐                           │      │
│   │   │  Form        │  │   DOM        │                           │      │
│   │   │  Detector    │  │   Injector   │                           │      │
│   │   └──────────────┘  └──────────────┘                           │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 组件说明

| 组件 | 职责 |
|------|------|
| **Popup** | 用户交互界面 |
| **Background** | 后台脚本，处理消息和存储 |
| **Content Script** | 注入页面，检测表单 |

---

## 四、核心功能

### 4.1 自动填充

```typescript
// Content Script - 表单检测
class FormDetector {
  detectLoginForm(): LoginForm | null {
    const forms = document.querySelectorAll('form');
    for (const form of forms) {
      const username = form.querySelector('input[type="email"], input[name="username"]');
      const password = form.querySelector('input[type="password"]');
      
      if (username && password) {
        return { form, username, password };
      }
    }
    return null;
  }
}

// Background - 自动填充
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.type === 'autofill') {
    const { username, password } = message.data;
    // 填充表单
  }
});
```

### 4.2 快速保存

```typescript
// 检测新注册表单并提示保存
class SavePrompt {
  async promptSave(data: { username: string; password: string; url: string }) {
    const tab = await chrome.tabs.query({ active: true, currentWindow: true });
    chrome.tabs.sendMessage(tab[0].id!, {
      type: 'show-save-prompt',
      data,
    });
  }
}
```

### 4.3 密码生成

```typescript
// 内置密码生成器
function generatePassword(options: {
  length: number;
  uppercase: boolean;
  lowercase: boolean;
  numbers: boolean;
  symbols: boolean;
}): string {
  // 生成随机密码
}
```

---

## 五、通信方式

### 5.1 通信架构

| 场景 | 通信方式 | 描述 |
|------|---------|------|
| 桌面端 | Native Messaging | 通过本地 HTTP 服务器 |
| 移动端 | Universal Links | 深度链接唤起应用 |
| Web 版 | 共享 WebDAV | 直接读取加密 vault |

### 5.2 消息传递

```typescript
// Popup -> Background
chrome.runtime.sendMessage({ type: 'get-vault' });

// Background -> Content Script
chrome.tabs.sendMessage(tabId, { type: 'autofill', data });

// Content Script -> Background
chrome.runtime.sendMessage({ type: 'form-detected', formData });
```

---

## 六、安全设计

### 6.1 安全原则

| 原则 | 实现 |
|------|------|
| **不存储主密码** | 每次操作需要用户输入 |
| **不长期存储密钥** | 短时会话，会话后清除 |
| **CSP 严格策略** | 禁止加载远程脚本 |
| **最小权限** | 仅请求必要权限 |

### 6.2 安全存储

```typescript
// 仅存储非敏感元数据
chrome.storage.local.set({
  vault: {
    lastSync: timestamp,
    entryCount: number,
    // 不存储任何敏感数据
  },
});
```

---

## 七、权限清单

### 7.1 Manifest 权限

```json
{
  "permissions": [
    "storage",
    "tabs",
    "activeTab",
    "nativeMessaging"
  ],
  "host_permissions": [
    "<all_urls>"
  ]
}
```

### 7.2 权限说明

| 权限 | 用途 |
|------|------|
| storage | 存储设置和缓存 |
| tabs | 获取当前标签页信息 |
| activeTab | 获取当前活动页面内容 |
| nativeMessaging | 与原生应用通信 |

---

## 八、开发计划

### 8.1 功能优先级

| 优先级 | 功能 | 版本 |
|--------|------|------|
| P0 | 自动填充 | v0.2.0 |
| P0 | 快速保存 | v0.2.0 |
| P1 | 密码生成器 | v0.2.0 |
| P1 | 快速搜索 | v0.2.0 |
| P2 | 与主应用通信 | v1.0.0 |

---

## 九、相关文档

- [整体架构](./整体架构.md) - 系统架构
- [安全架构](./安全架构.md) - 加密设计
- [版本规划](../06-开发计划/版本规划.md) - 开发计划
