# 同步架构

> **版本**: v1.1.0  
> **更新日期**: 2026-02-22  
> **作者**: Vaultly Team  
> **文档类型**: 架构文档

---

## 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-02-20 | 初始版本 | Vaultly Team |
| v1.1.0 | 2026-02-22 | 统一 SyncState 和 SyncStatus 定义 | Vaultly Team |

---

## 一、同步概述

### 1.1 同步目标

| 目标 | 描述 |
|------|------|
| **多设备同步** | iOS、Android、Desktop、Web 数据一致 |
| **端到端加密** | 服务器仅存储密文 |
| **冲突解决** | 自动检测与解决同步冲突 |
| **离线支持** | 网络断开时正常工作 |

### 1.2 支持的 WebDAV 服务

| 服务 | 状态 | 说明 |
|------|------|------|
| Nextcloud | ✅ 支持 | 广泛使用 |
| Synology NAS | ✅ 支持 | 本地 NAS |
| ownCloud | ✅ 支持 | 开源方案 |
| custom WebDAV | ✅ 支持 | 通用协议 |

---

## 二、同步架构

### 2.1 架构图

```mermaid
graph TB
    subgraph Local["本地端"]
        Vault[保险库]
        Crypto[加密服务]
        SyncEngine[同步引擎]
        SyncState[同步状态]
    end
    
    subgraph Remote["远程端"]
        WebDAV[WebDAV 服务器]
        RemoteVault[远程加密保险库]
        Metadata[元数据]
    end
    
    Vault --> Crypto
    Crypto --> SyncEngine
    SyncEngine --> SyncState
    SyncEngine --> WebDAV
    WebDAV --> RemoteVault
    WebDAV --> Metadata
```

### 2.2 同步组件

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           WebDAV 同步架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐          │
│   │   Local     │         │    Sync     │         │   Remote    │          │
│   │   Vault     │◄───────►│   Engine    │◄───────►│   WebDAV    │          │
│   │   (Isar)   │         │             │         │   Server    │          │
│   └─────────────┘         └──────┬──────┘         └─────────────┘          │
│                                  │                                           │
│                                  ▼                                           │
│                          ┌───────────────┐                                   │
│                          │  Sync State  │                                   │
│                          │  - lastSync   │                                   │
│                          │  - localHash  │                                   │
│                          │  - remoteHash │                                   │
│                          │  - conflict   │                                   │
│                          └───────────────┘                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、同步流程

### 3.1 完整同步流程

```dart
class SyncService {
  Future<SyncResult> sync() async {
    // 1. 获取远程 vault 元数据
    final remoteMeta = await webdav.getMetadata();
    
    // 2. 比较哈希值
    if (localHash == remoteHash) {
      return SyncResult(success: true); // 无需同步
    }
    
    // 3. 检测冲突
    if (_hasConflict(localMeta, remoteMeta)) {
      return await resolveConflict();
    }
    
    // 4. 拉取远程变更
    if (remoteMeta.updatedAt > localMeta.updatedAt) {
      await downloadAndMerge();
    }
    
    // 5. 上传本地变更
    if (localMeta.updatedAt > remoteMeta.updatedAt) {
      await uploadChanges();
    }
    
    // 6. 更新同步状态
    await _updateSyncState();
    
    return SyncResult(success: true);
  }
}
```

### 3.2 同步时序图

```mermaid
sequenceDiagram
    participant User as 用户
    participant App as 客户端
    participant Sync as 同步服务
    participant Local as 本地数据库
    participant WebDAV as WebDAV服务器

    User->>App: 点击同步
    App->>Sync: sync()
    Sync->>Local: 获取本地版本
    Sync->>WebDAV: 获取远程版本
    alt 版本一致
        WebDAV-->>App: 无需同步
        App-->>User: "已是最新"
    else 本地更新
        Sync->>Local: 读取数据
        Sync->>WebDAV: 上传加密数据
        WebDAV-->>Sync: 上传成功
        Sync-->>App: 同步成功
    else 远程更新
        Sync->>WebDAV: 下载数据
        WebDAV-->>Sync: 返回加密数据
        Sync->>Local: 合并数据
        Sync-->>App: 同步成功
    else 冲突
        Sync-->>App: 冲突检测
        App-->>User: 选择保留版本
    end
```

---

## 四、同步策略

### 4.1 同步模式

| 模式 | 描述 | 适用场景 |
|------|------|----------|
| **完整同步** | 上传/下载整个 vault | 首次同步、网络不稳定 |
| **增量同步** | 仅同步变更部分 | 日常同步、节省流量 |

### 4.2 同步触发

| 触发方式 | 描述 |
|---------|------|
| **手动触发** | 用户点击同步按钮 |
| **自动触发** | 应用启动/进入后台 |
| **定时触发** | 设置同步间隔 |
| **变更触发** | 条目变更后立即同步 |

### 4.3 冲突检测

```dart
class ConflictDetector {
  ConflictType detectConflict(LocalEntry local, RemoteEntry remote) {
    // 同一字段在本地和远程都修改
    if (local.updatedAt > lastSyncTime && 
        remote.updatedAt > lastSyncTime) {
      return ConflictType.sameField;
    }
    
    // 条目在本地删除但在远程修改
    if (local.isDeleted && !remote.isDeleted) {
      return ConflictType.deleteVsModify;
    }
    
    return ConflictType.none;
  }
}
```

### 4.4 冲突解决策略

| 场景 | 策略 | 用户操作 |
|------|------|---------|
| 仅远程修改 | 自动合并 | 无需 |
| 仅本地修改 | 自动上传 | 无需 |
| 同一字段都修改 | 提示用户选择 | 保留本地 / 保留远程 |
| 删除 vs 修改 | 提示用户选择 | 恢复 / 确认删除 |

---

## 五、WebDAV 集成

### 5.1 WebDAV 客户端

```dart
class WebDAVClient {
  final String baseUrl;
  final String username;
  final String password;
  
  Future<void> upload(String path, List<int> data) async {
    final client = WebDAVClient(
      baseUrl: baseUrl,
      credentials: WebDAVCredentials(username, password),
    );
    
    await client.upload(
      path,
      Stream.value(data),
      contentLength: data.length,
    );
  }
  
  Future<List<int>> download(String path) async {
    final client = WebDAVClient(/* ... */);
    return await client.download(path).first;
  }
  
  Future<FileStat> getMetadata(String path) async {
    final client = WebDAVClient(/* ... */);
    return await client.stat(path);
  }
}
```

### 5.2 同步数据结构

```dart
class SyncData {
  String vaultId;
  int version;
  String checksum;
  DateTime lastModified;
  List<EntryChange> changes;
}

class EntryChange {
  String entryId;
  ChangeType type; // add, update, delete
  String? encryptedData;
  DateTime timestamp;
}
```

---

## 六、同步状态管理

### 6.1 同步状态

```dart
enum SyncStatus {
  idle,           // 空闲
  checking,       // 检查中
  downloading,    // 下载中
  uploading,      // 上传中
  merging,        // 合并中
  conflicted,     // 冲突中
  resolving,      // 解决中
  success,        // 同步成功
  failure,        // 同步失败
}

class SyncState {
  final SyncStatus status;            // 当前状态
  final double progress;              // 进度（0-100）
  final String? currentOperation;     // 当前操作描述
  final DateTime? startedAt;          // 开始时间
  final DateTime? completedAt;        // 完成时间
  final DateTime? lastSyncAt;         // 最后同步时间
  final SyncError? error;             // 错误信息
  final List<Conflict>? conflicts;    // 冲突列表
}
```

### 6.2 同步状态 UI

| 状态 | 显示 |
|------|------|
| idle | 显示最后同步时间 |
| checking | 显示检查中动画 |
| downloading | 显示下载进度 |
| uploading | 显示上传进度 |
| merging | 显示合并中动画 |
| conflicted | 显示冲突解决弹窗 |
| resolving | 显示解决中状态 |
| success | 显示成功提示 |
| failure | 显示错误信息 + 重试按钮 |

---

## 七、相关文档

- [整体架构](./整体架构.md) - 系统架构
- [安全架构](./安全架构.md) - 加密设计
- [模块设计](../03-模块设计/同步模块.md) - 同步模块详细设计
- [版本规划](../06-开发计划/版本规划.md) - 开发计划
