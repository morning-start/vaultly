# å®‰å…¨æ¶æ„

## ä¸€ã€å®‰å…¨è®¾è®¡åŸåˆ™

### 1.1 æ ¸å¿ƒå®‰å…¨åŸåˆ™

| åŸåˆ™ | æè¿° | å®ç°æ–¹å¼ |
|------|------|----------|
| **é›¶çŸ¥è¯†æ¶æ„** | æœåŠ¡å™¨æ— æ³•è§£å¯†ç”¨æˆ·æ•°æ® | ç«¯åˆ°ç«¯åŠ å¯†ï¼Œä¸»å¯†ç æ°¸ä¸ä¸Šä¼  |
| **æœ¬åœ°ä¼˜å…ˆ** | æ•æ„Ÿæ•°æ®å­˜å‚¨åœ¨æœ¬åœ° | ç¦»çº¿å¯ç”¨ï¼Œæœ¬åœ°åŠ å¯† |
| **å†…å­˜å®‰å…¨** | æ•æ„Ÿæ•°æ®åŠæ—¶æ¸…é™¤ | Uint8List è¦†å†™ |
| **æœ€å°æƒé™** | ä»…è¯·æ±‚å¿…è¦æƒé™ | æƒé™åˆ†ç¦»ï¼Œå®‰å…¨å­˜å‚¨ |

---

## äºŒã€å¯†ç å­¦è®¾è®¡

### 2.1 åŠ å¯†ä½“ç³»

```mermaid
graph LR
    subgraph KeyDerivation["å¯†é’¥æ´¾ç”Ÿ"]
        Password[ä¸»å¯†ç ] --> Argon2[Argon2id]
        Salt[ç›å€¼] --> Argon2
        Argon2 --> MasterKey[ä¸»å¯†é’¥]
    end
    
    subgraph DataEncryption["æ•°æ®åŠ å¯†"]
        MasterKey --> AES[AES-256-GCM]
        PlainData[æ˜æ–‡æ•°æ®] --> AES
        IV[éšæœº IV] --> AES
        AES --> EncryptedData[åŠ å¯†æ•°æ®]
    end
    
    subgraph SecureStorage["å®‰å…¨å­˜å‚¨"]
        EncryptedData --> Isar[(Isar DB)]
        MasterKey --> SecureStore[Secure Storage]
    end
```

### 2.2 åŠ å¯†å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| **ç®—æ³•** | AES-256-GCM | å¯¹ç§°åŠ å¯† |
| **å¯†é’¥æ´¾ç”Ÿ** | Argon2id | æŠ—æš´åŠ›ç ´è§£ |
| **Argon2 memory** | 64 MB | å†…å­˜ hardness |
| **Argon2 iterations** | 3 | æ—¶é—´ hardness |
| **Argon2 parallelism** | 4 | å¹¶è¡Œåº¦ |
| **IV é•¿åº¦** | 12 bytes | GCM æ ‡å‡† |
| **Auth Tag** | 16 bytes | å®Œæ•´æ€§éªŒè¯ |

### 2.3 åŠ å¯†æµç¨‹

```dart
// åŠ å¯†æµç¨‹
class CryptoService {
  Future<EncryptedData> encrypt(String plainText, Uint8List key) async {
    // 1. ç”Ÿæˆéšæœº IV
    final iv = AES.generateIV();
    
    // 2. åˆ›å»ºåŠ å¯†å™¨
    final encrypter = Encrypter(AES(key, mode: AESMode.gcm));
    
    // 3. åŠ å¯†
    final encrypted = encrypter.encrypt(plainText, iv: iv);
    
    // 4. è¿”å›åŠ å¯†æ•°æ®ï¼ˆå« IV å’Œ Auth Tagï¼‰
    return EncryptedData(
      cipherText: encrypted.base64,
      iv: iv.base64,
      authTag: encrypted.bytes.last(16).base64, // GCM auth tag
      version: 1,
    );
  }
}
```

### 2.4 å¯†é’¥æ´¾ç”Ÿæµç¨‹

```dart
// å¯†é’¥æ´¾ç”Ÿæµç¨‹
class KeyDerivationService {
  Future<KeyMaterial> deriveKey(String password, Uint8List salt) async {
    // Argon2id å‚æ•°
    final params = Argon2Parameters(
      memory: 65536, // 64 MB
      iterations: 3,
      parallelism: 4,
      salt: salt,
    );
    
    // æ´¾ç”Ÿå¯†é’¥
    final argon2 = Argon2Algorithm();
    final result = argon2.hashPasswordBytes(
      password.codeUnits,
      params,
    );
    
    return KeyMaterial(
      key: Uint8List.fromList(result.hashBytes),
      salt: salt,
      hash: result.toString(),
    );
  }
}
```

---

## ä¸‰ã€å®‰å…¨ç‰¹æ€§

### 3.1 å®‰å…¨ç‰¹æ€§æ¸…å•

| å®‰å…¨ç‰¹æ€§ | å®ç°æ–¹å¼ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|---------|---------|--------|------|
| ä¸»å¯†ç æ´¾ç”Ÿ | Argon2id (memory=64MB) | P0 | ğŸ“‹ |
| å¯¹ç§°åŠ å¯† | AES-256-GCM | P0 | ğŸ“‹ |
| æ•æ„Ÿå­—æ®µåŠ å¯† | å…¨éƒ¨æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨ | P0 | ğŸ“‹ |
| ç”Ÿç‰©è¯†åˆ«è§£é” | local_auth + SecureKeyStore | P0 | ğŸ“‹ |
| é›¶çŸ¥è¯†åŒæ­¥ | ç«¯åˆ°ç«¯åŠ å¯† | P0 | ğŸ“‹ |
| å‰ªè´´æ¿ä¿æŠ¤ | å¤åˆ¶å 30 ç§’è‡ªåŠ¨æ¸…é™¤ | P1 | ğŸ“‹ |
| è‡ªåŠ¨é”å®š | 5/15/30 åˆ†é’Ÿå¯é€‰ | P1 | ğŸ“‹ |
| é˜²æˆªå›¾ | Android FLAG_SECURE | P1 | ğŸ“‹ |
| å†…å­˜å®‰å…¨ | Uint8List ä½¿ç”¨åè¦†å†™ | P2 | ğŸ“‹ |
| å®¡è®¡æ—¥å¿— | è®°å½•è®¿é—®æ—¶é—´ã€æ“ä½œç±»å‹ | P2 | ğŸ“‹ |

### 3.2 ç”Ÿç‰©è¯†åˆ«

```dart
class BiometricService {
  Future<bool> isAvailable() async {
    final localAuth = LocalAuthentication();
    return await localAuth.canCheckBiometrics;
  }
  
  Future<bool> authenticate({String reason = 'è§£é”ä¿é™©åº“'}) async {
    final localAuth = LocalAuthentication();
    return await localAuth.authenticate(
      localizedReason: reason,
      options: const AuthenticationOptions(
        stickyAuth: true,
        biometricOnly: true,
      ),
    );
  }
}
```

### 3.3 å‰ªè´´æ¿ä¿æŠ¤

```dart
class ClipboardService {
  Future<void> copyWithAutoClear(String text, {int clearAfterSeconds = 30}) async {
    await Clipboard.setData(ClipboardData(text: text));
    
    // å»¶è¿Ÿæ¸…é™¤
    Future.delayed(Duration(seconds: clearAfterSeconds), () {
      Clipboard.setData(const ClipboardData(text: ''));
    });
  }
}
```

---

## å››ã€å®‰å…¨å­˜å‚¨

### 4.1 å­˜å‚¨å±‚çº§

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | åŠ å¯†æ–¹å¼ |
|---------|---------|----------|
| åŠ å¯†å¯†é’¥ | Secure Storage | å¹³å°å®‰å…¨èŠ¯ç‰‡ |
| å¯†ç å“ˆå¸Œ | Isar DB | - |
| ç›å€¼ | Isar DB | - |
| æ•æ„Ÿå­—æ®µ | Isar DB | AES-256-GCM |
| åº”ç”¨è®¾ç½® | SharedPreferences | - |

### 4.2 å¹³å°å®‰å…¨é›†æˆ

```dart
// iOS Keychain
final storage = FlutterSecureStorage(
  iOptions: IOSOptions(
    accessibility: KeychainAccessibility.first_unlock_this_device,
  ),
);

// Android Keystore
final storage = FlutterSecureStorage(
  aOptions: AndroidOptions(
    encryptedSharedPreferences: true,
  ),
);

// Windows
// ä½¿ç”¨ DPAPI æˆ– Windows Hello
```

---

## äº”ã€WebDAV åŒæ­¥å®‰å…¨

### 5.1 é›¶çŸ¥è¯†åŒæ­¥

```mermaid
graph LR
    subgraph Client["å®¢æˆ·ç«¯"]
        PlainData[æ˜æ–‡æ•°æ®] --> Encrypt[AES-256-GCM]
        MasterKey[ä¸»å¯†é’¥] --> Encrypt
    end
    
    subgraph Network["ä¼ è¾“"]
        EncryptedData[åŠ å¯†æ•°æ®] --> HTTPS[HTTPS]
    end
    
    subgraph Server["WebDAV æœåŠ¡å™¨"]
        HTTPS --> Storage[ä»…å­˜å‚¨å¯†æ–‡]
    end
    
    Server -.-> "æ— æ³•è§£å¯†" .-> X[âŒ]
```

### 5.2 åŒæ­¥å®‰å…¨è¦æ±‚

| è¦æ±‚ | å®ç° |
|------|------|
| ä¼ è¾“åŠ å¯† | HTTPS (TLS 1.3) |
| å­˜å‚¨åŠ å¯† | å§‹ç»ˆå­˜å‚¨å¯†æ–‡ |
| å¯†é’¥ä¿æŠ¤ | å¯†é’¥ä¸ä¼ è¾“ã€ä¸å­˜å‚¨åœ¨æœåŠ¡å™¨ |
| å®Œæ•´æ€§æ ¡éªŒ | SHA-256 å“ˆå¸ŒéªŒè¯ |

---

## å…­ã€å®‰å…¨æ£€æŸ¥æ¸…å•

### 6.1 å¼€å‘å®‰å…¨æ£€æŸ¥

- [ ] ä¸»å¯†ç ä¸é€šè¿‡ç½‘ç»œä¼ è¾“
- [ ] åŠ å¯†å¯†é’¥ä¸å­˜å‚¨åœ¨çº¯æ–‡æœ¬
- [ ] æ•æ„Ÿæ•°æ®ä¸åœ¨æ—¥å¿—ä¸­è¾“å‡º
- [ ] å‰ªè´´æ¿è‡ªåŠ¨æ¸…é™¤è®¡æ—¶å™¨æ­£å¸¸
- [ ] è‡ªåŠ¨é”å®šåŠŸèƒ½æ­£å¸¸
- [ ] ç”Ÿç‰©è¯†åˆ«å¤±è´¥æœ‰å›é€€æœºåˆ¶

### 6.2 å®‰å…¨æµ‹è¯•

| æµ‹è¯•é¡¹ | æ–¹æ³• |
|--------|------|
| åŠ å¯†å¼ºåº¦ | éªŒè¯ AES-256-GCM å®ç° |
| å¯†é’¥æ´¾ç”Ÿ | éªŒè¯ Argon2id å‚æ•° |
| å†…å­˜å®‰å…¨ | éªŒè¯æ•æ„Ÿæ•°æ®æ¸…é™¤ |
| å‰ªè´´æ¿ | éªŒè¯è‡ªåŠ¨æ¸…é™¤ |
| ç”Ÿç‰©è¯†åˆ« | éªŒè¯å¤±è´¥å›é€€ |

---

## ä¸ƒã€ç›¸å…³æ–‡æ¡£

- [æ•´ä½“æ¶æ„](./æ•´ä½“æ¶æ„.md) - ç³»ç»Ÿæ¶æ„
- [åŒæ­¥æ¶æ„](./åŒæ­¥æ¶æ„.md) - WebDAV åŒæ­¥è®¾è®¡
- [æ•°æ®æ¨¡å‹](../04-æ•°æ®æ¨¡å‹/æ•°æ®å­—å…¸.md) - æ•°æ®ç»“æ„
- [å®‰å…¨æ£€æŸ¥æ¸…å•](../07-æ£€æŸ¥æ¸…å•/å®‰å…¨æ£€æŸ¥æ¸…å•.md) - å®‰å…¨æ£€æŸ¥é¡¹
