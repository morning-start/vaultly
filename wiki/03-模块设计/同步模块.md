# 同步模块

> **版本**: v1.1.0  
> **更新日期**: 2026-02-22  
> **作者**: Vaultly Team  
> **文档类型**: 模块文档

---

## 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-02-20 | 初始版本 | Vaultly Team |
| v1.1.0 | 2026-02-22 | 统一数据类型：SyncConfig、SyncState、SyncStatus、ConflictResolution | Vaultly Team |

---

## 一、模块概述

### 1.1 模块职责

同步模块负责客户端与 WebDAV 服务器之间的数据同步，支持端到端加密，确保数据安全和一致性。

### 1.2 核心功能

| 功能 | 描述 |
|------|------|
| WebDAV 连接 | 配置和测试 WebDAV 服务器 |
| 数据上传 | 加密上传本地数据 |
| 数据下载 | 加密下载远程数据 |
| 冲突解决 | 检测和解决同步冲突 |
| 同步管理 | 手动/自动同步控制 |

---

## 二、同步配置

### 2.1 同步配置

```dart
class SyncConfig {
  final String id;                    // 配置 ID
  final String serverUrl;             // WebDAV 服务器地址
  final String username;              // 用户名
  final String? password;             // 密码（存储在 Keychain）
  final String? appPassword;          // 应用专用密码
  final String remotePath;            // 远程路径（默认 /vaultly/）
  
  // 同步设置
  final SyncMode syncMode;            // 同步模式
  final Duration autoSyncInterval;    // 自动同步间隔
  final bool syncOnChange;            // 变更时同步
  final bool syncOnStartup;           // 启动时同步
  
  // 状态
  final bool isEnabled;               // 是否启用
  final DateTime? lastSyncAt;         // 最后同步时间
  final SyncStatus lastSyncStatus;    // 最后同步状态
}

enum SyncMode {
  auto,       // 自动双向同步
  manual,     // 仅手动同步
  uploadOnly, // 仅上传（备份模式）
  downloadOnly, // 仅下载（恢复模式）
}
```

### 2.2 配置界面

| 字段 | 类型 | 说明 |
|------|------|------|
| 服务器地址 | URL | WebDAV 服务器 URL |
| 用户名 | 字符串 | 认证用户名 |
| 密码 | 字符串 | 认证密码（存储在 Keychain）|
| 远程路径 | 字符串 | 保险库文件路径（默认 /vaultly/）|
| 同步模式 | 枚举 | auto / manual / uploadOnly / downloadOnly |
| 自动同步间隔 | Duration | 自动同步间隔时间 |
| 变更时同步 | 开关 | 数据变更后自动同步 |
| 启动时同步 | 开关 | 应用启动时自动同步 |

---

## 三、核心服务

### 3.1 SyncService

```dart
class SyncService {
  // 配置管理
  Future<void> saveConfig(SyncConfig config);
  Future<SyncConfig?> getConfig();
  Future<ConnectionResult> testConnection(SyncConfig config);
  
  // 同步操作
  Future<SyncResult> sync();
  Future<SyncResult> syncUpload();
  Future<SyncResult> syncDownload();
  
  // 状态查询
  Stream<SyncState> get syncStateStream;
  SyncState get currentState;
  bool get isSyncing;
  
  // 冲突解决
  Future<void> resolveConflict(String entryId, ConflictResolution resolution);
  Future<void> resolveAllConflicts(Map<String, ConflictResolution> resolutions);
  
  // 历史记录
  Future<List<SyncHistory>> getSyncHistory({int limit = 50});
  Future<void> clearSyncHistory();
}

enum ConflictResolution {
  keepLocal,    // 保留本地
  keepRemote,   // 保留远程
  merge,        // 合并
  skip,         // 跳过
}

class ConnectionResult {
  final bool success;
  final String? errorMessage;
  final ServerInfo? serverInfo;
}
```

### 3.2 SyncResult

```dart
class SyncResult {
  bool success;
  int added;
  int updated;
  int deleted;
  List<Conflict> conflicts;
  DateTime timestamp;
  String? errorMessage;
}
```

---

## 四、同步策略

### 4.1 同步模式

| 模式 | 描述 | 适用场景 |
|------|------|----------|
| **手动同步** | 用户触发同步 | 节省流量 |
| **启动同步** | 应用启动时同步 | 保持最新 |
| **定时同步** | 按间隔同步 | 实时同步 |
| **变更同步** | 立即同步变更 | 重要数据 |

### 4.2 同步流程

```dart
Future<SyncResult> sync() async {
  // 1. 检查连接
  if (!await _isConnected()) {
    return SyncResult(success: false, errorMessage: 'No connection');
  }
  
  // 2. 获取远程元数据
  final remoteMeta = await _webdav.getMetadata();
  
  // 3. 比较版本
  final compareResult = await _compareVersions(localMeta, remoteMeta);
  
  // 4. 处理同步
  switch (compareResult) {
    case CompareResult.localNewer:
      await _uploadChanges();
      break;
    case CompareResult.remoteNewer:
      await _downloadChanges();
      break;
    case CompareResult.conflict:
      return await _resolveConflicts();
    case CompareResult.identical:
      return SyncResult(success: true);
  }
  
  // 5. 更新状态
  await _updateSyncState();
  
  return SyncResult(success: true);
}
```

---

## 五、冲突处理

### 5.1 冲突类型

| 类型 | 描述 | 策略 |
|------|------|------|
| 修改冲突 | 同一字段都被修改 | 用户选择 |
| 删除冲突 | 本地删除 vs 远程修改 | 用户选择 |
| 新增冲突 | 相同 ID 的新条目 | 合并或覆盖 |

### 5.2 冲突解决 UI

```dart
class ConflictResolver {
  Future<ConflictResolution> showResolutionDialog(Conflict conflict) async {
    // 显示冲突信息
    // 让用户选择：
    // - 保留本地版本
    // - 保留远程版本
    // - 合并（如果支持）
  }
}
```

---

## 六、安全同步

### 6.1 端到端加密

```dart
class SecureSync {
  // 上传前加密
  Future<void> uploadEncrypted(List<VaultEntry> entries) async {
    final encryptedData = await _crypto.encryptEntries(entries);
    await _webdav.upload(encryptedData);
  }
  
  // 下载后解密
  Future<List<VaultEntry>> downloadAndDecrypt() async {
    final encryptedData = await _webdav.download();
    return await _crypto.decryptEntries(encryptedData);
  }
}
```

### 6.2 数据完整性

```dart
class IntegrityCheck {
  Future<bool> verifyChecksum(String data, String expectedChecksum) async {
    final actualChecksum = sha256.convert(data.codeUnits).toString();
    return actualChecksum == expectedChecksum;
  }
}
```

---

## 七、相关文档

- [整体架构](../02-架构设计/整体架构.md) - 系统架构
- [同步架构](../02-架构设计/同步架构.md) - 详细同步设计
- [安全架构](../02-架构设计/安全架构.md) - 安全设计
- [同步接口](../05-API接口/同步接口.md) - API 接口
