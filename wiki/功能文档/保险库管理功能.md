# 保险库管理功能

> **版本**: v1.1.0  
> **更新日期**: 2026-02-20  
> **作者**: Vaultly Team  
> **文档类型**: 功能文档（渐进式文档体系）

---

## 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|------|------|----------|------|
| v1.0.0 | 2026-02-20 | 初始版本 | Vaultly Team |
| v1.1.0 | 2026-02-20 | 补充代码实现映射、完善验收标准 | Vaultly Team |

---

## 一、功能概述

### 1.1 功能描述

保险库管理是 Vaultly 的核心功能，负责安全地存储、组织和管理用户的敏感信息。支持多种条目类型（登录凭证、银行卡、安全笔记、身份信息），提供强大的搜索、分类和加密保护功能。

### 1.2 用户场景

#### 场景 1：保存新网站账号
> 作为用户，我希望快速保存新注册网站的账号密码，以便日后自动填充。

**用户旅程：**
1. 点击"添加"按钮
2. 选择"登录凭证"类型
3. 输入网站名称、URL、用户名、密码
4. 可选：生成强密码
5. 可选：添加 TOTP 双因素认证
6. 保存条目

#### 场景 2：查找并使用密码
> 作为用户，我希望快速找到某个网站的密码并复制使用。

**用户旅程：**
1. 打开保险库（已解锁状态）
2. 使用搜索框输入网站名称
3. 点击目标条目
4. 点击"复制密码"按钮
5. 密码自动复制到剪贴板（30秒后清除）

#### 场景 3：管理银行卡信息
> 作为用户，我希望安全存储银行卡信息，方便在线购物时快速填写。

**用户旅程：**
1. 点击"添加" → "银行卡"
2. 输入卡号、持卡人、有效期、CVV
3. CVV 默认隐藏，可点击显示
4. 保存后卡片显示脱敏卡号（**** 1234）
5. 需要时复制卡号或 CVV

#### 场景 4：整理和分类
> 作为用户，我希望用标签和文件夹组织密码，保持整洁。

**用户旅程：**
1. 为条目添加标签（如"工作"、"个人"、"金融"）
2. 使用筛选器按标签查看
3. 收藏常用条目到"收藏夹"
4. 归档不再使用的条目

---

## 二、功能需求

### 2.1 功能清单

| 功能 ID | 功能名称 | 优先级 | 描述 |
|---------|---------|--------|------|
| VAULT-001 | 添加条目 | P0 | 创建新的保险库条目 |
| VAULT-002 | 编辑条目 | P0 | 修改现有条目内容 |
| VAULT-003 | 删除条目 | P0 | 删除条目（软删除） |
| VAULT-004 | 搜索条目 | P0 | 全文搜索条目 |
| VAULT-005 | 查看条目 | P0 | 查看条目详情 |
| VAULT-006 | 复制敏感信息 | P0 | 复制密码、卡号等 |
| VAULT-007 | 密码生成器 | P0 | 生成强随机密码 |
| VAULT-008 | 标签管理 | P1 | 添加/编辑/删除标签 |
| VAULT-009 | 收藏功能 | P1 | 收藏常用条目 |
| VAULT-010 | 条目历史 | P2 | 查看修改历史 |
| VAULT-011 | 批量操作 | P2 | 批量删除/移动 |
| VAULT-012 | 导入/导出 | P2 | 支持多种格式导入导出 |

### 2.2 条目类型

#### 登录凭证 (LoginEntry)

| 字段 | 类型 | 加密 | 说明 |
|------|------|------|------|
| 标题 | String | ❌ | 条目名称 |
| 用户名 | String | ❌ | 登录用户名 |
| 密码 | String | ✅ | 登录密码 |
| 网站 URL | String | ❌ | 关联网站 |
| TOTP 密钥 | String | ✅ | 双因素认证密钥 |
| 备注 | String | ✅ | 附加信息 |

#### 银行卡 (BankCardEntry)

| 字段 | 类型 | 加密 | 说明 |
|------|------|------|------|
| 标题 | String | ❌ | 卡片名称 |
| 卡号 | String | ✅ | 银行卡号 |
| 持卡人 | String | ❌ | 持卡人姓名 |
| 有效期 | Date | ❌ | MM/YY |
| CVV | String | ✅ | 安全码 |
| 银行名称 | String | ❌ | 发卡银行 |
| 卡类型 | Enum | ❌ | Visa/Mastercard 等 |

#### 安全笔记 (SecureNoteEntry)

| 字段 | 类型 | 加密 | 说明 |
|------|------|------|------|
| 标题 | String | ❌ | 笔记标题 |
| 内容 | String | ✅ | 笔记内容（支持 Markdown）|
| 是否 Markdown | Bool | ❌ | 格式标识 |

#### 身份信息 (IdentityEntry)

| 字段 | 类型 | 加密 | 说明 |
|------|------|------|------|
| 标题 | String | ❌ | 身份名称 |
| 姓名 | String | ❌ | 全名 |
| 身份证号 | String | ✅ | 证件号码 |
| 出生日期 | Date | ❌ | 生日 |
| 地址 | String | ✅ | 居住地址 |
| 电话 | String | ❌ | 联系电话 |
| 邮箱 | String | ❌ | 电子邮箱 |

### 2.3 自定义字段

每种条目类型支持添加自定义字段：

| 字段类型 | 说明 | 示例 |
|---------|------|------|
| 文本 | 普通文本 | 安全问题答案 |
| 隐藏文本 | 加密存储 | PIN 码 |
| 日期 | 日期选择 | 证件有效期 |
| URL | 链接 | 备用登录地址 |
| 邮箱 | 邮箱格式 | 备用邮箱 |

---

## 三、用户界面

### 3.1 界面清单

| 界面 | 描述 | 关键元素 |
|------|------|---------|
| 保险库主页 | 条目列表 | 搜索栏、筛选器、条目卡片列表 |
| 添加条目 | 创建新条目 | 类型选择、表单字段、密码生成器 |
| 条目详情 | 查看/编辑 | 字段显示、复制按钮、编辑/删除 |
| 搜索页面 | 全文搜索 | 搜索框、结果列表、筛选选项 |
| 标签管理 | 标签列表 | 标签云、添加/编辑/删除 |

### 3.2 界面原型

```
┌─────────────────────────────┐
│ 🔍 Search...        ⚙️  👤  │
├─────────────────────────────┤
│ 📌 Favorites    🏷️ Tags    │
├─────────────────────────────┤
│ ┌─────────────────────────┐ │
│ │ 🌐 github.com      🏷️  │ │
│ │ user@example.com    🔑  │ │
│ │ ************        📋  │ │
│ └─────────────────────────┘ │
│ ┌─────────────────────────┐ │
│ │ 💳 招商银行信用卡   🏷️  │ │
│ │ **** **** **** 8888     │ │
│ │ 张三                    │ │
│ └─────────────────────────┘ │
│ ┌─────────────────────────┐ │
│ │ 📝 WiFi 密码        🏷️  │ │
│ │ Home_Network_5G         │ │
│ └─────────────────────────┘ │
│                             │
│         ➕  Add             │
└─────────────────────────────┘
```

---

## 四、验收标准

### 4.1 功能验收

| 验收项 | 验收标准 | 测试方法 |
|--------|---------|---------|
| 添加条目 | 所有类型条目可正常创建 | 端到端测试 |
| 编辑条目 | 修改后数据正确保存 | 单元测试 |
| 删除条目 | 删除后条目不可见，可恢复 | 集成测试 |
| 搜索功能 | 支持标题、用户名、URL 搜索 | 单元测试 |
| 复制功能 | 敏感信息可复制，剪贴板定时清除 | 手动测试 |
| 密码生成 | 生成密码符合强度要求 | 单元测试 |

### 4.2 性能验收

| 指标 | 目标值 | 测量方法 |
|------|--------|---------|
| 列表加载 | < 100ms（100条） | 性能测试 |
| 搜索响应 | < 200ms | 性能测试 |
| 条目打开 | < 100ms | 性能测试 |
| 加密/解密 | < 50ms | 性能测试 |

### 4.3 安全验收

| 验收项 | 验收标准 |
|--------|---------|
| 敏感字段加密 | 密码、卡号、CVV 等必须加密存储 |
| 内存安全 | 解密后的敏感数据不长期驻留内存 |
| 剪贴板保护 | 复制的敏感信息 30 秒后自动清除 |
| 防截屏 | 敏感页面启用 FLAG_SECURE |

---

## 五、代码实现映射

### 5.1 核心实现文件

| 功能 | 实现文件 | 关键类/方法 |
|------|----------|-------------|
| **保险库服务** | `lib/core/services/vault_service.dart` | `VaultService` |
| **条目模型** | `lib/core/models/vault_entry.dart` | `VaultEntry`, `LoginEntry`, `BankCardEntry` |
| **密码生成器** | `lib/core/utils/password_generator.dart` | `PasswordGenerator.generate()` |
| **剪贴板服务** | `lib/core/services/clipboard_service.dart` | `ClipboardService.copy()` |
| **保险库页面** | `lib/ui/pages/vault_page.dart` | `VaultPage` |
| **添加条目页** | `lib/ui/pages/add_entry_page.dart` | `AddEntryPage` |
| **条目详情页** | `lib/ui/pages/entry_detail_page.dart` | `EntryDetailPage` |

### 5.2 字段级加密实现

```dart
// lib/core/services/vault_service.dart
class VaultService {
  // 加密敏感字段
  Future<EncryptedData> _encryptSensitiveFields(
    Map<String, dynamic> sensitiveData,
    Uint8List vaultKey,
  ) async {
    final jsonData = jsonEncode(sensitiveData);
    return CryptoService.encrypt(jsonData, vaultKey);
  }
  
  // 解密敏感字段
  Future<Map<String, dynamic>> _decryptSensitiveFields(
    EncryptedData encryptedData,
    Uint8List vaultKey,
  ) async {
    final jsonData = CryptoService.decrypt(encryptedData, vaultKey);
    return jsonDecode(jsonData);
  }
}
```

### 5.3 条目类型继承体系

```dart
// lib/core/models/vault_entry.dart
abstract class VaultEntry {
  final String id;
  final String title;
  final EntryType type;
  final DateTime createdAt;
  final DateTime updatedAt;
  final EncryptedData encryptedData;
  // ...
}

class LoginEntry extends VaultEntry {
  final String? url;
  final String? username;
  // 敏感字段存储在 encryptedData 中
}

class BankCardEntry extends VaultEntry {
  final String cardHolderName;
  final CardType cardType;
  // 卡号、CVV 存储在 encryptedData 中
}
```

---

## 六、相关文档

### 6.1 渐进式文档链
- [保险库管理需求文档](../需求文档/保险库管理需求.md) - 数据模型、数据流动、状态管理
- [保险库管理架构文档](../架构文档/保险库管理架构.md) - 技术选型、实现方案

### 6.2 数据流动
- [保险库CRUD数据流](../数据流动/保险库CRUD数据流.md) - 数据流动设计

### 6.3 数据模型
- [数据字典](../04-数据模型/数据字典.md) - 核心数据结构
- [加密结构](../04-数据模型/加密结构.md) - 加密数据格式

### 6.4 模块设计
- [保险库模块](../03-模块设计/保险库模块.md) - 详细模块设计

---

## 七、变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.1.0 | 2026-02-20 | 补充代码实现映射、完善验收标准 | Vaultly Team |
| v1.0.0 | 2026-02-20 | 初始版本 | Vaultly Team |
