# Vaultly 密码管理器 - 架构设计文档

## 一、项目概述

### 1.1 项目背景

Vaultly 是一款跨平台密码与敏感信息管理器，采用端到端加密设计，支持多设备同步。项目定位为安全、私密、易用的个人保险库，适用于管理账号密码、银行卡片、身份信息及自定义敏感数据。

### 1.2 核心目标

- **多平台覆盖**：iOS、Android、Desktop (Windows/macOS/Linux)、Web
- **浏览器扩展**：支持 Chrome、Firefox、Edge 等主流浏览器
- **端到端加密**：零知识架构，服务器无法解密用户数据
- **WebDAV 同步**：支持自建 NAS (Nextcloud、Synology、ownCloud)

### 1.3 非功能性需求

| 需求类型 | 要求 |
|---------|------|
| 安全性 | AES-256-GCM 加密、Argon2id 密钥派生、生物识别解锁 |
| 性能 | 启动时间 < 2s、加密操作 < 100ms |
| 可用性 | 99.9% 可用、离线可用（本地优先） |
| 数据一致性 | 冲突检测与解决机制 |

---

## 二、整体架构设计

### 2.1 架构分层图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层 (Flutter)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │
│  │   Mobile    │  │   Desktop   │  │     Web     │  │  Browser Ext   │   │
│  │ (iOS/Android│  │ (Win/Mac/Lin│  │ (Flutter Web│  │      (WXT)     │   │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘   │
└─────────┼────────────────┼────────────────┼──────────────────┼─────────────┘
          │                │                │                  │
          ▼                ▼                ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          核心业务逻辑层 (Domain)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │
│  │   Auth      │  │   Vault     │  │  Sync       │  │  TOTP           │   │
│  │   Service   │  │   Service   │  │  Service    │  │  Service        │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           数据访问层 (Data)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │
│  │   Local DB  │  │  WebDAV     │  │  Crypto     │  │  Biometric     │   │
│  │   (Isar)    │  │  Client     │  │  Provider   │  │  Provider       │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           存储层 (Storage)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────┐    ┌─────────────────────────────────────┐   │
│  │   Local Encrypted DB     │    │   Remote WebDAV Server             │   │
│  │   (Isar + AES-256)       │◄──►│   (Nextcloud/Synology/NAS)         │   │
│  └─────────────────────────┘    └─────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心模块架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Flutter App                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Presentation Layer                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐  │   │
│  │  │  Login   │ │  Vault   │ │  Add/Edit │ │ Settings │ │  Sync  │  │   │
│  │  │   Page   │ │   Page   │ │   Entry   │ │   Page   │ │  Page  │  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    State Management (Riverpod)                    │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐  │   │
│  │  │  Auth    │ │  Vault   │ │  TOTP    │ │  Sync    │ │ Settings│  │   │
│  │  │ Notifier │ │ Notifier │ │ Notifier │ │ Notifier │ │Notifier│  │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Service Layer                               │   │
│  │  ┌──────────────────────────────────────────────────────────────┐ │   │
│  │  │                    CryptoService                               │ │   │
│  │  │  - deriveKey(password, salt) → Key                           │ │   │
│  │  │  - encrypt(data, key) → EncryptedData                        │ │   │
│  │  │  - decrypt(encryptedData, key) → data                         │ │   │
│  │  └──────────────────────────────────────────────────────────────┘ │   │
│  │  ┌──────────────────────────────────────────────────────────────┐ │   │
│  │  │                    VaultService                              │ │   │
│  │  │  - addEntry(entry)                                           │ │   │
│  │  │  - updateEntry(entry)                                        │ │   │
│  │  │  - deleteEntry(id)                                           │ │   │
│  │  │  - searchEntries(query)                                       │ │   │
│  │  │  - getEntryById(id)                                           │ │   │
│  │  └──────────────────────────────────────────────────────────────┘ │   │
│  │  ┌──────────────────────────────────────────────────────────────┐ │   │
│  │  │                    AuthService                                │ │   │
│  │  │  - setupMasterPassword(password)                              │ │   │
│  │  │  - verifyMasterPassword(password) → bool                     │ │   │
│  │  │  - unlockWithBiometric() → bool                              │ │   │
│  │  │  - lock()                                                     │ │   │
│  │  └──────────────────────────────────────────────────────────────┘ │   │
│  │  ┌──────────────────────────────────────────────────────────────┐ │   │
│  │  │                    SyncService                                │ │   │
│  │  │  - connectWebDAV(config)                                      │ │   │
│  │  │  - syncToRemote()                                             │ │   │
│  │  │  - syncFromRemote()                                           │ │   │
│  │  │  - resolveConflict(local, remote)                            │ │   │
│  │  └──────────────────────────────────────────────────────────────┘ │   │
│  │  ┌──────────────────────────────────────────────────────────────┐ │   │
│  │  │                    TOTPService                                │ │   │
│  │  │  - generateTOTP(secret) → code                               │ │   │
│  │  │  - parseOTPAuthURI(uri) → TOTPConfig                         │ │   │
│  │  │  - validateTOTP(code, secret) → bool                         │ │   │
│  │  └──────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Data Repository Layer                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │   │
│  │  │ IsarRepo     │  │ WebDAVRepo   │  │ PrefsRepo    │             │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Platform Integration                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │   │
│  │  │ local_auth   │  │ flutter_secure│  │ webdav_client│             │   │
│  │  │ (Biometric)  │  │ (Keychain)    │  │              │             │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、技术选型

### 3.1 核心技术栈

| 模块 | 推荐技术 | 备选方案 | 选择理由 |
|------|---------|---------|---------|
| **框架** | Flutter 3.27+ | React Native | 跨平台能力强，性能优秀 |
| **状态管理** | Riverpod | flutter_bloc | 轻量、类型安全、易测试 |
| **本地数据库** | Isar | Hive | 高性能、支持复杂查询、加密支持 |
| **加密** | encrypt + pointycastle | flutter_secure_storage | AES-256-GCM 标准实现 |
| **密钥派生** | argon2 | PBKDF2 | 更强抗暴力破解 |
| **TOTP** | otp | 自研 | 成熟、社区验证 |
| **WebDAV** | webdav_client | http + XML | 专为 WebDAV 设计 |
| **UI** | Material 3 | Cupertino | Flutter 官方推荐 |
| **浏览器插件** | WXT | - | 轻量、Modern Manifest V3 |

### 3.2 依赖包推荐

```yaml
dependencies:
  flutter:
    sdk: flutter
  
  # 状态管理
  flutter_riverpod: ^2.5.0
  riverpod_annotation: ^2.3.0
  
  # 本地数据库
  isar: ^3.1.0
  isar_flutter_libs: ^3.1.0
  path_provider: ^2.1.0
  
  # 加密
  encrypt: ^5.0.0
  pointycastle: ^3.7.0
  crypto: ^3.0.0
  
  # 密钥派生
  argon2: ^0.1.0
  
  # WebDAV
  webdav_client: ^3.0.0
  
  # TOTP
  otp: ^3.1.0
  
  # 生物识别
  local_auth: ^2.1.0
  
  # 安全存储
  flutter_secure_storage: ^9.0.0
  
  # 剪贴板
  super_clipboard: ^0.8.0
  
  # QR 码
  mobile_scanner: ^5.0.0
  
  # UUID
  uuid: ^4.0.0
  
  # URL Launcher
  url_launcher: ^6.2.0
  
  # JSON
  json_annotation: ^4.8.0
  
  # 国际化
  flutter_localizations:
    sdk: flutter
  intl: ^0.19.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  build_runner: ^2.4.0
  riverpod_generator: ^2.3.0
  isar_generator: ^3.1.0
  json_serializable: ^6.7.0
  flutter_lints: ^3.0.0
```

---

## 四、数据模型设计

### 4.1 核心实体

```dart
// 基础条目
abstract class VaultEntry {
  String id;
  String title;
  DateTime createdAt;
  DateTime updatedAt;
  EntryType type;
  List<CustomField> customFields;
  List<String> tags;
}

// 登录凭证
class LoginEntry extends VaultEntry {
  String? username;
  String? email;
  String password;        // 加密存储
  String? url;
  String? totpSecret;    // 加密存储
  String? notes;
  List<String> favIcons; // 网站图标缓存
}

// 银行卡
class BankCardEntry extends VaultEntry {
  String cardNumber;     // 加密存储
  String cardHolderName;
  int expiryMonth;
  int expiryYear;
  String? cvv;           // 加密存储，可隐藏
  String? bankName;
  CardType cardType;     // Visa, Mastercard, etc.
}

// 安全笔记
class SecureNoteEntry extends VaultEntry {
  String content;        // 加密存储 (Markdown)
  bool isMarkdown;
}

// 身份信息
class IdentityEntry extends VaultEntry {
  String? firstName;
  String? lastName;
  String? middleName;
  DateTime? birthDate;
  String? idNumber;      // 加密存储
  String? address;
  String? phone;
  String? email;
}

// 自定义字段
class CustomField {
  String name;
  String value;          // 加密存储
  FieldType type;        // text, hidden, date, url
  bool isSecret;
}
```

### 4.2 加密结构

```dart
class EncryptedData {
  String cipherText;     // Base64 编码的密文
  String iv;            // 初始化向量 (12 bytes, Base64)
  String authTag;       // 认证标签 (16 bytes, Base64)
  int version;          // 加密版本号
}

class VaultMetadata {
  String id;            // Vault 唯一标识
  int version;          // 数据结构版本
  String salt;          // 主密码盐值 (Base64)
  String argon2Hash;    // Argon2id 哈希 (用于验证)
  DateTime lastSyncedAt;
  int entryCount;
  String checksum;      // 数据完整性校验
}
```

---

## 五、安全设计

### 5.1 加密流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           密码学安全设计                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    1. 首次设置主密码                                  │   │
│  │                                                                     │   │
│  │   User Password ──► Argon2id ──► Key + Salt                        │   │
│  │                            │                                        │   │
│  │                            ▼                                        │   │
│  │                    Salt + Hash ──► 存储                            │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    2. 加密数据                                      │   │
│  │                                                                     │   │
│  │   Plain Text ──► AES-256-GCM ──► Cipher + IV + AuthTag             │   │
│  │                         │                                           │   │
│  │                         ▼                                           │   │
│  │                    EncryptedData ──► 存储/传输                     │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    3. 解密数据                                      │   │
│  │                                                                     │   │
│  │   EncryptedData + Key ──► AES-256-GCM Decrypt ──► Plain Text       │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 安全特性清单

| 安全特性 | 实现方式 | 优先级 |
|---------|---------|--------|
| 主密码派生 | Argon2id (memory=64MB, iterations=3, parallelism=4) | P0 |
| 对称加密 | AES-256-GCM | P0 |
| 本地数据加密 | 全部敏感字段加密存储 | P0 |
| 生物识别解锁 | local_auth + SecureKeyStore | P0 |
| 零知识同步 | 端到端加密，服务器只存密文 | P0 |
| 剪贴板保护 | 复制后 30 秒自动清除 | P1 |
| 自动锁定 |  inactivity 5/15/30 分钟可选 | P1 |
| 防截图 | Android FLAG_SECURE | P1 |
| 内存安全 | Uint8List 使用后覆写 | P2 |
| 审计日志 | 记录访问时间、操作类型 | P2 |

---

## 六、WebDAV 同步设计

### 6.1 同步架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           WebDAV 同步架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐          │
│   │   Local     │         │    Sync     │         │   Remote    │          │
│   │   Vault     │◄───────►│   Engine    │◄───────►│   WebDAV    │          │
│   │   (Isar)    │         │             │         │   Server    │          │
│   └─────────────┘         └──────┬──────┘         └─────────────┘          │
│                                  │                                           │
│                                  ▼                                           │
│                          ┌───────────────┐                                   │
│                          │  Sync State  │                                   │
│                          │  - lastSync   │                                   │
│                          │  - localHash  │                                   │
│                          │  - remoteHash │                                   │
│                          │  - conflict   │                                   │
│                          └───────────────┘                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 同步流程

```dart
enum SyncStrategy {
  full,      // 完整同步（上传/下载整个 vault）
  incremental, // 增量同步（仅同步变更）
}

class SyncResult {
  bool success;
  int added;
  int updated;
  int deleted;
  List<Conflict> conflicts;
  DateTime syncTimestamp;
}

Future<SyncResult> sync() async {
  // 1. 获取远程 vault 元数据
  final remoteMeta = await webdav.getMetadata();
  
  // 2. 比较哈希值
  if (localHash == remoteHash) {
    return SyncResult(success: true); // 无需同步
  }
  
  // 3. 检测冲突
  if (localMeta.updatedAt > remoteMeta.updatedAt && 
      remoteMeta.updatedAt > lastSyncTime) {
    // 本地和远程都有修改 - 冲突
    return await resolveConflict();
  }
  
  // 4. 拉取远程变更
  if (remoteMeta.updatedAt > localMeta.updatedAt) {
    await downloadAndMerge();
  }
  
  // 5. 上传本地变更
  if (localMeta.updatedAt > remoteMeta.updatedAt) {
    await uploadChanges();
  }
}
```

### 6.3 冲突解决策略

| 场景 | 策略 | 用户操作 |
|------|------|---------|
| 仅远程修改 | 自动合并 | 无需 |
| 仅本地修改 | 自动上传 | 无需 |
| 同一字段本地和远程都修改 | 提示用户选择 | 保留本地 / 保留远程 / 合并 |

---

## 七、浏览器插件设计 (WXT)

### 7.1 插件架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           WXT 浏览器插件架构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                      Popup (弹出窗口)                            │      │
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │      │
│   │   │  Quick   │  │  Search  │  │  Generate │  │   Settings   │  │      │
│   │   │  Access  │  │   Vault  │  │  Password │  │              │  │      │
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────────┘  │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                      Background Script                          │      │
│   │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │      │
│   │   │  Vault       │  │   AutoFill   │  │   Message    │          │      │
│   │   │  Manager     │  │   Handler    │  │   Bridge     │          │      │
│   │   └──────────────┘  └──────────────┘  └──────────────┘          │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐      │
│   │                      Content Script                             │      │
│   │   ┌──────────────┐  ┌──────────────┐                           │      │
│   │   │  Form        │  │   DOM        │                           │      │
│   │   │  Detector    │  │   Injector   │                           │      │
│   │   └──────────────┘  └──────────────┘                           │      │
│   └─────────────────────────────────────────────────────────────────┘      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 通信方式

| 场景 | 通信方式 | 描述 |
|------|---------|------|
| 桌面端 | Native Messaging | 通过本地 HTTP 服务器或系统消息 |
| 移动端 | Universal Links / App Links | 深度链接唤起应用 |
| Web 版 | 共享同一 WebDAV 源 | 直接读取加密 vault |

### 7.3 安全原则

- **不存储主密码**：每次操作需用户输入或短时会话
- **内存安全**：解密数据使用后立即清除
- **CSP 严格策略**：禁止加载远程脚本
- **最小权限**：仅请求必要权限

---

## 八、开发路线图

### 8.1 版本规划

| 阶段 | 版本 | 时间 | 目标 |
|------|------|------|------|
| **Phase 1** | v0.1.0 | 1-2 个月 | MVP |
| **Phase 2** | v0.2.0 | 3-4 个月 | 完善功能 |
| **Phase 3** | v1.0.0 | 5-6 个月 | 正式发布 |

### 8.2 Phase 1: MVP (1-2 个月)

#### 目标
快速验证核心功能，完成最小可行产品

#### 任务清单

```
Week 1-2: 基础框架
├── Flutter 项目初始化
├── Riverpod 状态管理搭建
└── 项目结构组织

Week 3-4: 核心加密
├── Isar 数据库集成
├── AES-256-GCM 加密实现
├── Argon2id 主密码派生
└── 加密数据模型

Week 5-6: 登录与保险库
├── 主密码设置/验证界面
├── 登录/解锁流程
├── 保险库主界面
└── 条目列表/搜索

Week 7-8: 条目管理
├── 添加/编辑/删除登录凭证
├── 条目详情页
├── 自定义字段支持
└── 密码生成器

Week 9: WebDAV 同步
├── WebDAV 客户端集成
├── 手动同步（上传/下载）
└── 同步状态显示

Week 10: TOTP 支持
├── TOTP 生成器
├── 扫码添加
└── 与登录条目关联
```

### 8.3 Phase 2: 增强功能 (3-4 个月)

```
Month 3: 银行卡与笔记
├── 银行卡条目类型
├── 安全笔记（Markdown）
└── 身份信息条目

Month 4: 生物识别与安全
├── 指纹/Face ID 解锁
├── Android Autofill
├── iOS AutoFill Extension
└── 自动锁定功能

Month 5: 浏览器插件
├── WXT 插件开发
├── 自动填充
├── 快速保存
└── 与主应用通信
```

### 8.4 Phase 3: 优化与发布 (5-6 个月)

```
Month 6: 完善与发布
├── 增量同步
├── 冲突解决 UI
├── 多语言支持
├── 性能优化
└── 正式发布
```

---

## 九、关键数据流

### 9.1 用户登录流程

```
用户输入主密码
       │
       ▼
┌──────────────────┐
│  Argon2id 派生   │ ──► 生成加密密钥
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  验证密码哈希    │ ◄── 与存储的哈希比对
└────────┬─────────┘
         │
         ▼ (验证成功)
┌──────────────────┐
│  加载加密数据库  │
│  到内存（解密）  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  进入保险库主界面 │
└──────────────────┘
```

### 9.2 添加新条目流程

```
用户点击"添加条目"
       │
       ▼
┌──────────────────┐
│  选择条目类型    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  填写条目信息    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  点击"保存"      │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  AES-256-GCM 加密│ ◄── 使用内存中的密钥
│  敏感字段        │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  写入 Isar 数据库│
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  更新本地哈希    │
└──────────────────┘
```

---

## 十、可扩展性设计

### 10.1 模块化架构

```
vaultly/
├── packages/
│   ├── core/                  # 核心加密、通用工具
│   │   ├── crypto/
│   │   ├── models/
│   │   └── utils/
│   ├── data/                  # 数据层
│   │   ├── repositories/
│   │   ├── datasources/
│   │   └── providers/
│   ├── domain/                # 业务逻辑
│   │   ├── services/
│   │   └── entities/
│   ├── features/              # 功能模块
│   │   ├── auth/
│   │   ├── vault/
│   │   ├── sync/
│   │   └── totp/
│   └── app/                   # 主应用入口
└── extensions/
    └── browser/               # 浏览器插件
```

### 10.2 插件化设计

未来可扩展的功能：
- **密码健康检查**：检测弱密码、重复密码
- **数据导入/导出**：支持 1Password、Bitwarden 格式
- **紧急访问**：设置可信赖的紧急联系人
- **安全分享**：加密分享单个条目

---

## 十一、测试策略

### 11.1 测试金字塔

```
         ┌─────────────┐
         │   E2E Test  │  ◄── 关键用户流程
         │ (Widget)    │
       ┌─┴─────────────┴─┐
       │  Integration    │  ◄── 模块间协作
       │     Tests       │
     ┌─┴─────────────────┴─┐
     │    Unit Tests      │  ◄── 核心逻辑
     │  (加密、同步、TOTP) │
     └─────────────────────┘
```

### 11.2 安全测试要点

- 加密/解密正确性验证
- 密钥派生一致性
- TOTP 验证码有效性
- WebDAV 同步冲突处理
- 剪贴板自动清除
- 生物识别失败回退

---

## 十二、总结

Vaultly 密码管理器采用现代 Flutter 技术栈，实现了一个安全、可靠、易用的跨平台密码管理解决方案。架构设计遵循以下原则：

1. **安全第一**：端到端加密、零知识架构、内存安全
2. **本地优先**：离线可用，本地加密存储
3. **开放同步**：支持自建 WebDAV，兼容主流 NAS
4. **模块化**：清晰的层级划分，易于维护和扩展
5. **用户友好**：简洁 UI、快速解锁、直观操作

本架构为项目开发提供了完整的技术蓝图，团队可按阶段逐步实现各项功能。
