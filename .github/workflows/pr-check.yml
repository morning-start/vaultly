name: PR Check

on:
  pull_request:
    branches:
      - main
      - dev

env:
  FLUTTER_VERSION: '3.38.9'
  JAVA_VERSION: '17'

jobs:
  # 代码格式检查
  format-check:
    name: 代码格式检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 检查代码格式
        run: |
          if ! flutter format --set-exit-if-changed --dry-run .; then
            echo "❌ 代码格式检查失败，请运行 'flutter format .' 修复格式问题"
            exit 1
          fi

  # 代码分析
  analyze:
    name: 代码分析
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 运行代码分析
        run: flutter analyze --fatal-infos

  # 单元测试
  test:
    name: 单元测试
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 运行测试
        run: flutter test --coverage

      - name: 上传覆盖率报告
        uses: codecov/codecov-action@v3
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false

  # Android 构建测试
  build-android-test:
    name: Android 构建测试
    runs-on: ubuntu-latest
    needs: [format-check, analyze]
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: 设置 Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: 获取依赖
        run: flutter pub get

      - name: 构建 Android Debug APK
        run: flutter build apk --debug

  # PR 检查汇总
  pr-check-summary:
    name: PR 检查汇总
    needs: [format-check, analyze, test, build-android-test]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: 检查所有任务状态
        run: |
          echo "格式检查: ${{ needs.format-check.result }}"
          echo "代码分析: ${{ needs.analyze.result }}"
          echo "单元测试: ${{ needs.test.result }}"
          echo "Android 构建: ${{ needs.build-android-test.result }}"

      - name: 检查是否通过
        if: |
          needs.format-check.result != 'success' ||
          needs.analyze.result != 'success' ||
          needs.test.result != 'success' ||
          needs.build-android-test.result != 'success'
        run: |
          echo "❌ PR 检查未通过"
          exit 1

      - name: 检查通过
        run: |
          echo "✅ 所有 PR 检查已通过！"
